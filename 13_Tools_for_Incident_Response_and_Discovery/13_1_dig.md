| **Inicio**         | **Siguiente 2**      |
| ------------------ | -------------------- |
| [üè†](../README.md) | [‚è©](./13_2_NMAP.md) |

---

## **√çndice**

| Temario                                                                          |
| -------------------------------------------------------------------------------- |
| [412. C√≥mo usar el comando dig en Linux](#412-c√≥mo-usar-el-comando-dig-en-linux) |
| [413. C√≥mo buscar registros DNS con dig](#413-c√≥mo-buscar-registros-dns-con-dig) |

# **Dig**

## **412. C√≥mo usar el comando dig en Linux**

![Dig](/img/13_Tools_for_Incident_Response_and_Discovery/Dig.jpg "Dig")

### Introducci√≥n

`dig` (Domain Information Groper) es la herramienta est√°ndar para hacer consultas DNS desde la terminal: flexible, scriptable y muy √∫til para troubleshooting.

### Sintaxis b√°sica

```
dig [@servidor] [nombre] [tipo] [opciones]
```

- `@servidor` (opcional): servidor DNS al que preguntas (ej. `@8.8.8.8`).
- `nombre`: dominio o direcci√≥n IP (para reverse lookup se usa `-x`).
- `tipo` (opcional): `A`, `AAAA`, `MX`, `TXT`, `NS`, `SOA`, `CNAME`, `AXFR`, `ANY`, etc.
- `opciones`: `+short`, `+trace`, `+dnssec`, `+noall +answer`, `+tcp`, `-p` (puerto), `-4`/`-6`, etc.

### Partes principales de la salida de `dig` (salida de ejemplo y qu√© significa)

Ejemplo de comando:

```bash
dig example.com A
```

Salida de ejemplo (resumida):

```
; <<>> DiG 9.16.1-Ubuntu <<>> example.com A
;; global options: +cmd
;; QUESTION SECTION:
;example.com.            IN    A

;; ANSWER SECTION:
example.com.         86399   IN   A    93.184.216.34

;; AUTHORITY SECTION:
...

;; ADDITIONAL SECTION:
...

;; Query time: 12 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Mon Sep 15 12:00:00 UTC 2025
;; MSG SIZE  rcvd: 123
```

Qu√© significa:

- **QUESTION SECTION**: la pregunta enviada.
- **ANSWER SECTION**: la(s) respuesta(s) (A, AAAA, MX, etc.). Si aparece, indica el RR y el TTL (ej. `86399`).
- **AUTHORITY SECTION**: servidores autorizados para la zona (cuando la respuesta no es totalmente autoritativa).
- **ADDITIONAL SECTION**: registros adicionales, por ejemplo A de los servidores MX.
- **Query time**: tiempo que tard√≥ la consulta.
- **SERVER**: resolver que respondi√≥ (tu DNS local o el que especificaste).
- **flags** en el header (`aa`, `qr`, `rd`, `ra`, `ad`...):

  - `aa`: respuesta autoritativa.
  - `ra`: recursion available (el servidor puede delegar recursion).
  - `ad`: autenticado (DNSSEC).

### Ejemplos pr√°cticos y cu√°ndo usarlos

1. **Consulta b√°sica (A record)**

```bash
dig example.com A
```

Muestra todo el bloque de informaci√≥n (√∫til para ver header/authority/additional).

2. **Salida corta ‚Äî ideal para scripts**

```bash
dig +short example.com A
# -> 93.184.216.34
```

3. **Obtener registros MX (mail)**

```bash
dig example.com MX +short
# -> 10 mail.example.com.
```

Luego puedes resolver el host del MX:

```bash
dig +short mail.example.com A
```

4. **Consultar texto (SPF, DKIM, etc.)**

```bash
dig example.com TXT +short
# -> "v=spf1 include:_spf.example.com -all"
```

5. **Consultar el servidor autoritativo directamente**

```bash
dig @8.8.8.8 example.com A +short
```

√ötil para comparar respuestas entre tu DNS local y un resolver p√∫blico (p. ej. Google `8.8.8.8` o Cloudflare `1.1.1.1`).

6. **B√∫squeda inversa (PTR)**

```bash
dig -x 8.8.8.8 +short
# -> dns.google.
```

7. **Ver toda la cadena de resoluci√≥n (traza, para ver propagaci√≥n/NS delegaciones)**

```bash
dig +trace example.com
```

`+trace` mostrar√° las consultas desde los root servers hasta el autoritativo, paso a paso.

8. **Forzar TCP (√∫til para respuestas grandes o AXFR)**

```bash
dig +tcp example.com ANY
```

9. **Intentar transferencia de zona (AXFR) ‚Äî solo si el servidor lo permite**

```bash
dig @ns1.example.com example.com AXFR
```

Precauci√≥n: la mayor√≠a de servidores leg√≠timos niegan AXFR a clientes no autorizados.

10. **Comando para mostrar _solo_ la secci√≥n de respuesta (sin encabezados ni estad√≠sticas)**

```bash
dig +noall +answer example.com A
```

11. **Comprobar DNSSEC**

```bash
dig example.com A +dnssec
```

Devuelve los registros RRSIG y permite verificar si la zona est√° firmada.

12. **Forzar IPv4 o IPv6**

```bash
dig -4 example.com A   # fuerza IPv4
dig -6 example.com AAAA # fuerza IPv6
```

13. **Especificar puerto DNS (si el servidor escucha en otro puerto)**

```bash
dig -p 5353 @dns.example.com example.com A
```

### Uso en scripts ‚Äî ejemplos pr√°cticos

Obtener la IP y asignarla a variable en bash:

```bash
ip=$(dig +short example.com A | tail -n1)
echo "IP: $ip"
```

Script simple que espera a que un dominio apunte a una IP dada:

```bash
#!/bin/bash
target="93.184.216.34"
domain="example.com"
for i in {1..10}; do
  ip=$(dig +short $domain A | tail -n1)
  echo "Intento $i: $ip"
  if [ "$ip" = "$target" ]; then
    echo "Propagado"
    exit 0
  fi
  sleep 30
done
echo "No se propag√≥ en el tiempo esperado"
```

Obtener y ordenar MX por prioridad:

```bash
dig +short example.com MX | sort -n
```

### Instalaci√≥n en Linux

- **Debian / Ubuntu**:

```bash
sudo apt update
sudo apt install dnsutils
```

- **RHEL / CentOS / Fedora**:

```bash
sudo dnf install bind-utils   # o `yum install bind-utils` en versiones antiguas
```

- **Arch**:

```bash
sudo pacman -S bind-tools
```

(En macOS `dig` suele venir con el sistema o con `bind` y en Windows podr√≠as instalar BIND tools o usar `nslookup` o WSL.)

### Consejos, trucos y errores comunes

- `+short` es tu amigo para scripts (reduce salida a lo esencial).
- `ANY` a menudo no devuelve datos completos ‚Äî muchos servidores la bloquean. Mejor preguntar por tipos concretos (A, MX, TXT).
- Si ves **respuesta no autoritativa**, intenta preguntar al servidor autoritativo (`@ns...`) para confirmar.
- Para comprobar propagaci√≥n: compara la respuesta de tu resolver local vs un p√∫blico (`@8.8.8.8`, `@1.1.1.1`) y contra el autoritativo.
- El **TTL** indica cu√°nto tiempo un resolver cachear√° la respuesta. Chequea el SOA `serial` para ver si la zona cambi√≥ (serial suele incrementarse para nuevas versiones).
- Si necesitas depurar por qu√© un cliente particular no ve el cambio: verificar caches intermedios (ISP resolvers) y TTL.

### Mini cheat-sheet r√°pido

- `dig example.com` ‚Äî consulta por defecto (A).
- `dig +short example.com` ‚Äî salida compacta.
- `dig example.com MX` ‚Äî registros MX.
- `dig -x 8.8.8.8 +short` ‚Äî reverse PTR.
- `dig @8.8.8.8 example.com A` ‚Äî consulta a servidor espec√≠fico.
- `dig +trace example.com` ‚Äî ver la resoluci√≥n completa desde root.
- `dig @ns1.example.com example.com AXFR` ‚Äî intentar transferencia de zona.

---

[üîº](#√≠ndice)

---

## **413. C√≥mo buscar registros DNS con dig**

### Qu√© significa _buscar registros DNS con `dig`_

Buscar registros DNS con `dig` quiere decir preguntar a servidores DNS por los distintos **resource records (RR)** que describen un dominio: su IP (A/AAAA), sus servidores de correo (MX), textos de verificaci√≥n (TXT), alias (CNAME), servidores autoritativos (NS), registros de zona (SOA), PTR para reversos, SRV para servicios, etc. `dig` es la herramienta de l√≠nea de comandos m√°s usada en Linux para hacer esas consultas: es flexible, muestra detalles √∫tiles para depuraci√≥n y se puede usar en scripts.

A continuaci√≥n tienes una **gu√≠a completa con ejemplos pr√°cticos** y c√≥mo interpretar la salida.

### Sintaxis b√°sica

```
dig [@servidor] [nombre] [tipo] [opciones]
```

- `@servidor` (opcional): servidor DNS al que preguntar (ej. `@8.8.8.8`).
- `nombre`: dominio, subdominio o direcci√≥n (con `-x` para reverso).
- `tipo`: `A`, `AAAA`, `MX`, `TXT`, `CNAME`, `NS`, `SOA`, `PTR`, `SRV`, `AXFR`, `ANY`, etc.
- `opciones`: `+short`, `+noall +answer`, `+trace`, `+dnssec`, `+tcp`, `-p <puerto>`, `-4`/`-6`, etc.

### Tipos de registros (qu√© significan) y c√≥mo consultarlos

#### A ‚Äî direcci√≥n IPv4

Muestra la IP v4 asociada a un nombre.

```bash
dig example.com A
```

Salida relevante (simplificada):

```
;; ANSWER SECTION:
example.com. 86399 IN A 93.184.216.34
```

Interpretaci√≥n: `example.com` apunta a `93.184.216.34`. El n√∫mero (86399) es el **TTL** en segundos.

#### AAAA ‚Äî direcci√≥n IPv6

```bash
dig example.com AAAA +short
# -> (posible salida vac√≠a si no hay IPv6)
```

#### MX ‚Äî servidores de correo (con prioridad)

```bash
dig example.com MX +short
# -> 10 mail.example.com.
#    20 backup.example.com.
```

Ordena por prioridad (menor = prioridad mayor). Para obtener la IP de un MX:

```bash
dig +short mail.example.com A
```

#### TXT ‚Äî textos (SPF, DKIM, DMARC, verificaci√≥n)

```bash
dig example.com TXT +short
# -> "v=spf1 include:spf.proveedor.com -all"
```

#### CNAME ‚Äî alias

```bash
dig www.example.com CNAME +short
# -> host.example.com.
```

#### NS ‚Äî servidores autoritativos de la zona

```bash
dig example.com NS +short
# -> ns1.example.com.
#    ns2.example.com.
```

#### SOA ‚Äî Start Of Authority (datos de la zona)

Muestra el servidor primario, admin, serial y tiempos (refresh, retry, expiry, minimum).

```bash
dig example.com SOA +short
# -> ns1.example.com. hostmaster.example.com. 2023091501 3600 600 2419200 3600
```

Campos: primary NS, admin (puntos en vez de @), `serial` (√∫til para saber si la zona cambi√≥), refresh, retry, expire, minimum TTL.

#### PTR ‚Äî b√∫squeda inversa (reverse)

A partir de una IP obtienes el nombre PTR:

```bash
dig -x 93.184.216.34 +short
# -> example.com.
```

#### SRV ‚Äî servicios (ej.: SIP, XMPP)

```bash
dig _sip._tcp.example.com SRV +short
# -> 10 60 5060 sipserver.example.com.
```

Formato: `priority weight port target`.

#### ANY ‚Äî todos los registros (no fiable)

```bash
dig example.com ANY
```

Nota: muchos servidores limitan o bloquean `ANY`, por eso es mejor pedir tipos concretos.

### Opciones √∫tiles y c√≥mo simplifican la salida

- `+short` ‚Äî salida breve, ideal para scripts.

  ```bash
  dig +short example.com A
  ```

- `+noall +answer` ‚Äî oculta headers y muestra solo la secci√≥n ANSWER.

  ```bash
  dig example.com A +noall +answer
  ```

- `@servidor` ‚Äî preguntar a un servidor espec√≠fico.

  ```bash
  dig @8.8.8.8 example.com A +short
  ```

- `+trace` ‚Äî seguimiento desde los root servers hasta el autoritativo (√∫til para ver delegaciones).

  ```bash
  dig +trace example.com
  ```

- `+dnssec` ‚Äî solicita datos DNSSEC (RRSIG) para comprobar firma.

  ```bash
  dig example.com A +dnssec
  ```

- `+tcp` ‚Äî forzar TCP (√∫til con respuestas grandes o para AXFR).

  ```bash
  dig +tcp example.com ANY
  ```

- `-x` ‚Äî reverse lookup (ya mostrado arriba).
- `-4` / `-6` ‚Äî forzar IPv4 o IPv6 en la consulta.
- `-p <puerto>` ‚Äî preguntar a puerto distinto si el servidor no escucha en 53.

### C√≥mo interpretar la salida (partes importantes)

Salida t√≠pica (resumida):

```
;; QUESTION SECTION:
;example.com.   IN  A

;; ANSWER SECTION:
example.com. 86399 IN A 93.184.216.34

;; AUTHORITY SECTION:
example.com. 172800 IN NS ns1.example.com.

;; ADDITIONAL SECTION:
ns1.example.com. 172800 IN A 203.0.113.5

;; Query time: 12 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: ...
```

- **QUESTION**: lo que preguntaste.
- **ANSWER**: la respuesta (aqu√≠ el A record + TTL).
- **AUTHORITY**: servidores autoritativos (√∫til si la respuesta fue delegada).
- **ADDITIONAL**: registros adicionales (p.ej. A para los NS o MX).
- **SERVER**: qu√© resolver respondi√≥ (tu resolver local o el que especificaste).
- **Query time**: tiempo para la consulta.
- **flags** en la cabecera (`aa`, `ra`, `ad`, etc.) indican autoritatividad, recursion disponible y si DNSSEC valid√≥ (`ad` = authenticated data).

### Flujos de depuraci√≥n comunes (paso a paso)

#### 1) ¬øEl dominio resuelve?

```bash
dig example.com A +short
```

Si no retorna IP -> revisar `NXDOMAIN` o `SERVFAIL`.

#### 2) ¬øLa respuesta viene del cache o es autoritativa?

- Ver tu resolver:

  ```bash
  dig example.com A
  ```

  f√≠jate en `SERVER:` (p. ej. `127.0.0.53`) y en flags.

- Pregunta al servidor autoritativo:

  ```bash
  dig @ns1.example.com example.com A +noall +answer
  ```

  Si la respuesta difiere, hay cach√© intermedia.

#### 3) Problemas con correo

- Ver MX:

  ```bash
  dig example.com MX +short | sort -n
  ```

- Resolver cada MX a su IP:

  ```bash
  dig +short mail.example.com A
  ```

#### 4) Ver delegaciones (si hay problema de delegaci√≥n)

```bash
dig +trace example.com
```

`+trace` muestra los pasos: root ‚Üí TLD ‚Üí autoritativos; √∫til para ver d√≥nde falla la delegaci√≥n.

#### 5) DNSSEC

```bash
dig example.com A +dnssec
```

Busca RRSIG y el flag `ad` en la cabecera para ver si la respuesta est√° autenticada.

#### 6) Transferencia de zona (AXFR) ‚Äî solo con permiso

```bash
dig @ns1.example.com example.com AXFR
```

La mayor√≠a de servidores leg√≠timos niegan AXFR a clientes externos.

### Ejemplos pr√°cticos para scripts (automaci√≥n)

Esperar a que un dominio apunte a cierta IP:

```bash
#!/bin/bash
domain="example.com"
target="93.184.216.34"
for i in {1..12}; do
  ip=$(dig +short $domain A | tail -n1)
  echo "Intento $i: $ip"
  if [ "$ip" = "$target" ]; then
    echo "El dominio ya apunta a $target"
    exit 0
  fi
  sleep 30
done
echo "No apunt√≥ a $target en el tiempo esperado"
```

Obtener y probar IPs de los MX:

```bash
dig +short example.com MX | sort -n | awk '{print $2}' | while read mx; do
  echo "MX: $mx -> IP(s):"
  dig +short $mx A
done
```

Sacar solo el SOA serial (√∫til para ver cambios de zona):

```bash
dig example.com SOA +short | awk '{print $3}'
# -> muestra el n√∫mero serial (ej. 2023091501)
```

### Errores comunes y consejos pr√°cticos

- `ANY` suele no devolver todo; pregunta por tipos concretos.
- TTL: si cambias un registro espera hasta que el TTL anterior expire para que los resolvers de terceros se actualicen.
- Comparar resolvers: siempre compara tu resolver local con uno p√∫blico (`@8.8.8.8`, `@1.1.1.1`) y con el autoritativo para entender si el problema es de cach√©.
- Si recibes `REFUSED` o `SERVFAIL`, revisa firewall y configuraci√≥n del servidor DNS.
- Si `dig -x` no devuelve PTR, el propietario de la IP (ISP) debe configurar el PTR, no el due√±o del dominio.
- Para ver si un registro CNAME est√° ocultando otros registros: un nombre con CNAME no puede coexistir con otros registros (norma DNS).

### Mini cheat-sheet de comandos r√°pidos

- `dig example.com` ‚Äî consulta A (por defecto).
- `dig +short example.com A` ‚Äî salida compacta.
- `dig example.com MX` ‚Äî registros MX.
- `dig -x 93.184.216.34 +short` ‚Äî reverse PTR.
- `dig @8.8.8.8 example.com A` ‚Äî pregunta a Google DNS.
- `dig +trace example.com` ‚Äî ver delegaciones desde root.
- `dig example.com SOA +short` ‚Äî ver SOA (serial y tiempos).
- `dig example.com TXT +short` ‚Äî ver SPF/DMARC/DKIM u otros TXT.

---

[üîº](#√≠ndice)

---

| **Inicio**         | **Siguiente 2**      |
| ------------------ | -------------------- |
| [üè†](../README.md) | [‚è©](./13_2_NMAP.md) |
