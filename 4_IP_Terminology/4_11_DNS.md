| **Inicio**         | **atr√°s 10**         | **Siguiente 12**    |
| ------------------ | -------------------- | ------------------- |
| [üè†](../README.md) | [‚è™](./4_10_DHCP.md) | [‚è©](./4_12_NAT.md) |

---

## **√çndice**

| Temario                                |
| -------------------------------------- |
| [96. ¬øQu√© es DNS?](#96-qu√©-es-dns)     |
| [97. DNS explicado](#97-dns-explicado) |

# **DNS**

## **96. ¬øQu√© es DNS?**

![DHCP](/img/4_IP_Terminology/DNS.png "DHCP")

### 1. ¬øQu√© es DNS?

**DNS (Domain Name System)** es el sistema que traduce **nombres de dominio** f√°ciles de recordar (como `google.com`) en **direcciones IP** (como `142.250.72.206`) que las computadoras necesitan para comunicarse en Internet.

üëâ **Ejemplo real**:

Cuando escribes `www.wikipedia.org` en tu navegador, DNS se encarga de encontrar la IP de los servidores de Wikipedia para que tu navegador pueda cargar la p√°gina.

Se le conoce como la **‚Äúgu√≠a telef√≥nica de Internet‚Äù**, porque convierte nombres en n√∫meros.

### 2. ¬øC√≥mo funciona DNS?

El funcionamiento de DNS se basa en un **proceso de consulta y respuesta** entre varios servidores.

Cuando un usuario escribe una URL, el sistema sigue estos pasos:

1. El navegador pregunta: ‚Äú¬øCu√°l es la IP de `www.wikipedia.org`?‚Äù
2. La petici√≥n pasa por distintos servidores DNS hasta obtener la respuesta.
3. El navegador se conecta al servidor web usando la IP recibida.

### 3. Los 4 servidores DNS que intervienen al cargar un sitio web

Cada b√∫squeda DNS involucra **hasta cuatro tipos de servidores**:

1. **Servidor recursivo (resolver)**

   - Es el primero que recibe la solicitud del cliente (PC, m√≥vil, router).
   - Si tiene la respuesta en su cach√©, la devuelve al instante.
   - Ejemplos: servidores DNS de Google (`8.8.8.8`), Cloudflare (`1.1.1.1`), o los del ISP.

2. **Servidor ra√≠z (root server)**

   - Hay 13 grupos de servidores ra√≠z en todo el mundo.
   - Responden: ‚ÄúNo s√© la IP de `wikipedia.org`, pero s√© qu√© servidores manejan `.org`‚Äù.

3. **Servidor TLD (Top-Level Domain)**

   - Maneja dominios de nivel superior, como `.com`, `.org`, `.net`.
   - Ejemplo: para `wikipedia.org`, el servidor TLD `.org` responde: ‚ÄúPregunta a los servidores autoritativos de `wikipedia.org`‚Äù.

4. **Servidor autoritativo**

   - Tiene la informaci√≥n definitiva del dominio (`wikipedia.org`).
   - Devuelve la IP correcta del servidor web.

üëâ Diagrama simple:

```
Cliente (PC)
   ‚Üì
Servidor Recursivo
   ‚Üì
Servidor Ra√≠z
   ‚Üì
Servidor TLD (.org)
   ‚Üì
Servidor Autoritativo (wikipedia.org)
   ‚Üì
IP final ‚Üí Navegador carga el sitio
```

### 4. Diferencia entre **servidor DNS autoritativo** y **resoluci√≥n recursiva**

- **Servidor autoritativo**:

  - Contiene la **respuesta oficial** de un dominio.
  - Ejemplo: Los servidores autoritativos de `wikipedia.org` saben la IP de `www.wikipedia.org`.

- **Resoluci√≥n recursiva (resolver)**:

  - Es el ‚Äúintermediario‚Äù que hace todo el trabajo de preguntar a ra√≠z, TLD y autoritativos.
  - Ejemplo: Cuando usas `8.8.8.8`, Google DNS hace la resoluci√≥n recursiva por ti.

üëâ En resumen:

- El **recursivo** busca respuestas.
- El **autoritativo** da la respuesta final.

### 5. Pasos en una b√∫squeda DNS

1. Escribes `www.wikipedia.org` en el navegador.
2. El **resolver** (ej. `8.8.8.8`) recibe la consulta.
3. Si no est√° en cach√©, pregunta al **servidor ra√≠z**.
4. El servidor ra√≠z responde: ‚ÄúBusca en los servidores `.org`‚Äù.
5. El resolver pregunta al **servidor TLD `.org`**.
6. El TLD responde: ‚ÄúPregunta a los servidores autoritativos de `wikipedia.org`‚Äù.
7. El resolver consulta al **autoritativo de wikipedia.org**.
8. El autoritativo responde con la IP (`208.80.154.224`).
9. El resolver guarda la respuesta en cach√© y la devuelve al navegador.
10. El navegador ya sabe a qu√© IP conectarse.

### 6. ¬øQu√© es una resoluci√≥n de DNS?

La **resoluci√≥n de DNS** es el proceso de convertir un **nombre de dominio en una direcci√≥n IP** mediante consultas entre los servidores mencionados.

Existen dos modos principales:

- **Resoluci√≥n recursiva**: el resolver hace todas las preguntas y devuelve la respuesta final.
- **Resoluci√≥n iterativa**: el resolver devuelve ‚Äúpistas‚Äù y el cliente contin√∫a preguntando (menos com√∫n en usuarios finales).

### 7. Tipos de consultas de DNS

1. **Consulta recursiva**:

   - El cliente pide al servidor recursivo que obtenga la respuesta completa.
   - Ejemplo: Tu PC pide a `8.8.8.8` la IP de `google.com`.

2. **Consulta iterativa**:

   - El servidor responde con la mejor informaci√≥n que tiene, aunque no sea la IP final.
   - Ejemplo: El servidor ra√≠z responde con la direcci√≥n de un servidor TLD, no con la IP final.

3. **Consulta inversa (Reverse DNS Lookup)**:

   - Traduce una direcci√≥n IP en un nombre de dominio.
   - Ejemplo: `8.8.8.8` ‚Üí `dns.google`.

### 8. ¬øQu√© es el cach√© de DNS? ¬øD√≥nde se produce?

El **cach√© DNS** es el almacenamiento temporal de respuestas DNS para acelerar futuras consultas.

Se produce en varios niveles:

- **Cach√© del sistema operativo** (Windows, Linux, macOS).

  - Ejemplo: `ipconfig /displaydns` en Windows.

- **Cach√© del navegador** (Chrome, Firefox).

  - Ejemplo: Chrome tiene `chrome://net-internals/#dns`.

- **Cach√© en el resolver** (ej. `8.8.8.8`).
- **Cach√© en el propio servidor autoritativo** (dependiendo del TTL configurado).

üëâ **Ejemplo pr√°ctico**:

Si visitas `wikipedia.org` y luego lo visitas de nuevo, tu sistema operativo probablemente ya tenga la IP en cach√©, as√≠ que no repite todo el proceso con los servidores ra√≠z/TLD.

‚úÖ **En resumen**:

- DNS traduce nombres ‚Üî IPs.
- Involucra **4 servidores**: recursivo, ra√≠z, TLD y autoritativo.
- Las consultas pueden ser recursivas, iterativas o inversas.
- El **cach√©** hace que Internet sea mucho m√°s r√°pido, guardando respuestas anteriores.

---

[üîº](#√≠ndice)

---

## **97. DNS explicado**

### 1) ¬øQu√© es DNS (en una frase)?

**DNS** es el sistema distribuido que traduce **nombres de dominio legibles** (por ejemplo `www.ejemplo.com`) en **direcciones IP** (por ejemplo `93.184.216.34`) ‚Äî y tambi√©n proporciona otros metadatos (correo, servidores autoritativos, pol√≠ticas, etc.). Piensa en DNS como la gu√≠a telef√≥nica de Internet.

### 2) Jerarqu√≠a y componentes principales

DNS es **jer√°rquico y delegable**. Niveles clave:

- **Resolver (stub resolver)**: componente del cliente (SO, navegador) que inicia la consulta.
- **Servidor recursivo (resolver recursivo)**: servidor al que el cliente pide la respuesta completa (ej. `8.8.8.8`, `1.1.1.1`, o los del ISP).
- **Servidores ra√≠z (root servers)**: punto de partida; conocen los servidores TLD (existen 13 conjuntos l√≥gicos: A‚ÄìM).
- **Servidores TLD**: manejan `.com`, `.org`, `.es`, etc.; devuelven los servidores autoritativos para el dominio.
- **Servidores autoritativos**: contienen los registros reales (A, MX, NS, SOA...) para un dominio.
- **Registrador / Registry**: quien gestiona el dominio (registro) y las delegaciones NS en el TLD.

### 3) Tipos de registros DNS (los m√°s usados) ‚Äî con ejemplos

- **A** ‚Üí IPv4. `www.ejemplo.com. 3600 IN A 93.184.216.34`
- **AAAA** ‚Üí IPv6. `www.ejemplo.com. 3600 IN AAAA 2606:2800:220:1:248:1893:25c8:1946`
- **CNAME** ‚Üí alias. `blog.ejemplo.com. 3600 IN CNAME ghs.googlehosted.com.`
- **MX** ‚Üí mail exchangers (prioridad).
  `ejemplo.com. 3600 IN MX 10 mail.ejemplo.com.`
- **NS** ‚Üí servidores autoritativos del dominio.
  `ejemplo.com. 3600 IN NS ns1.proveedor.net.`
- **SOA** ‚Üí Start Of Authority (metadatos del zona: serial, refresh, retry, expire, minimum TTL).
- **PTR** ‚Üí apuntador para **reverse DNS** (IP ‚Üí nombre).
  `34.216.184.93.in-addr.arpa. 86400 IN PTR server.ejemplo.com.`
- **TXT** ‚Üí texto arbitrario (SPF, verificaci√≥n, DKIM).
- **SRV** ‚Üí servicios (√∫sos de SIP, LDAP, etc.).
- **CAA** ‚Üí define qu√© CA puede emitir certificados TLS para el dominio.

### 4) ¬øC√≥mo funciona la resoluci√≥n DNS? (proceso paso a paso)

Supongamos que tu navegador necesita la IP de `www.ejemplo.com`. Resumen del flujo (modo **recursivo**, que usa la mayor√≠a de clientes):

1. **Cliente** (stub resolver) pregunta al **resolver recursivo** (p. ej. servidor del ISP o `8.8.8.8`): ‚Äú¬øcu√°l es la IP de `www.ejemplo.com`?‚Äù
2. El recursivo revisa su **cach√©**. Si no hay respuesta:
3. Pregunta al **servidor ra√≠z**: ‚Äú¬øqui√©n conoce `.com`?‚Äù ‚Üí ra√≠z responde con la lista de servidores TLD `.com`.
4. El recursivo pregunta a uno de los **TLD**: ‚Äú¬øqui√©n es autoritativo para `ejemplo.com`?‚Äù ‚Üí el TLD responde con los **NS autoritativos** para `ejemplo.com`.
5. El recursivo pregunta al **autoritativo**: ‚Äú¬øqu√© A/AAAA tiene `www.ejemplo.com`?‚Äù ‚Üí el autoritativo responde con la IP (y TTL).
6. El recursivo guarda la respuesta en cach√© (por el TTL) y se la devuelve al cliente.
7. El cliente conecta a la IP recibida.

Diagrama simplificado:

```
Cliente ‚Üí Resolver recursivo ‚Üí Root ‚Üí TLD ‚Üí Autoritativo ‚Üí (respuesta vuelta)
```

**Iterativa vs recursiva:**

- En **recursiva**, el resolver hace todas las preguntas por ti y retorna la respuesta final.
- En **iterativa**, el cliente recibe punteros y debe preguntar sucesivamente (m√°s habitual en servidores entre s√≠ o en demostraciones, no en el uso diario).

### 5) Puertos y transporte

- **UDP 53** para la mayor√≠a de consultas (r√°pido, stateless).
- **TCP 53** se usa cuando: la respuesta supera el tama√±o UDP, para transferencias de zona (AXFR) o para conexiones exigentes (DNS sobre TCP es fallback).
- **DoT (DNS over TLS, TCP 853)** y **DoH (DNS over HTTPS, TCP/443)**: versiones cifradas y privada de resoluci√≥n de DNS.

### 6) Cach√© DNS: qu√© es, d√≥nde ocurre y TTL

- **TTL (Time To Live)**: tiempo (segundos) que la respuesta ser√° considerada v√°lida en cach√©. El autoritativo establece el TTL.
- **¬øD√≥nde se cachea?**

  - **Resolver recursivo** (ISP, Google DNS, Cloudflare) ‚Äî el lugar m√°s relevante para rendimiento.
  - **Sistema operativo** (ej.: `systemd-resolved`, `nscd` o Windows DNS Client).
  - **Navegador** (Chrome, Firefox) mantiene su propio cach√© DNS.
  - **Dispositivos intermedios** (caching DNS forwarders como `dnsmasq`) y proxies.

- **Ejemplo:** si A record para `www.ejemplo.com` tiene `TTL 3600`, el resolver lo guardar√° 1 hora. Antes de expirar, futuras peticiones usan cache y evitan consultas hacia root/TLD/autoritativo.

### 7) Archivos de zona / ejemplo pr√°ctico (BIND-style)

Archivo de zona `ejemplo.com.db` simplificado:

```
$TTL 3600
@   IN SOA  ns1.proveedor.net. hostmaster.ejemplo.com. (
        2024080101 ; serial YYYYMMDDnn
        3600       ; refresh
        900        ; retry
        604800     ; expire
        86400      ; minimum/negative TTL
)
    IN NS   ns1.proveedor.net.
    IN NS   ns2.proveedor.net.

; Registros A / AAAA
@   IN A    93.184.216.34
www IN A    93.184.216.34
@   IN AAAA 2606:2800:220:1::1946

; MX
@   IN MX 10 mail.ejemplo.com.
mail IN A   93.184.216.40

; CNAME
blog IN CNAME ghs.googlehosted.com.

; TXT (SPF)
@   IN TXT "v=spf1 mx -all"
```

- **SOA**: control de la zona; `serial` se incrementa cuando actualizas la zona.
- **NS**: delegaci√≥n del dominio.
- **A/AAAA**: apuntan host ‚Üí IP.
- **MX**: servidores de correo.
- **CNAME**: alias (no mezclar CNAME y otros registros en la misma etiqueta).

### 8) Reverse DNS (PTR) ‚Äî ejemplo

Para la IP `93.184.216.34`, la b√∫squeda inversa consulta `34.216.184.93.in-addr.arpa.` y el PTR podr√≠a apuntar a `www.ejemplo.com.`. Los bloques IPv6 usan `ip6.arpa.` con nibbles invertidos.

### 9) DNSSEC (breve)

- DNSSEC a√±ade **firmas digitales** a los registros: **DNSKEY**, **RRSIG**, **DS**.
- Objetivo: garantizar **integridad y autenticidad** de las respuestas DNS (proteger contra cache poisoning / spoofing).
- Concepto: la zona publica sus claves; el parent (.com) contiene un **DS** para enlazar la cadena de confianza hasta la ra√≠z.

### 10) Delegaci√≥n, zonas y transferencia

- **Delegaci√≥n**: TLD apunta a tus nameservers (NS).
- **AXFR / IXFR**: transferencias de zona entre primario y secundarios (TCP 53).
- Los secundarios obtienen la zona del primario usando AXFR/IXFR o notificaciones (NOTIFY).

### 11) Comandos pr√°cticos: `dig` y `nslookup` (con ejemplos)

**a)** `dig @resolver www.ejemplo.com A`

- `@resolver` es opcional; si no, usa default.
- `+short` muestra solo la IP.
- `+trace` sigue la resoluci√≥n desde la ra√≠z (√∫til para ver paso a paso).

**Ejemplo de uso y qu√© ver:**

- `dig www.ejemplo.com +trace` ‚Üí ver√°s consultas a root ‚Üí TLD ‚Üí autoritativo.
- `dig @8.8.8.8 example.com MX` ‚Üí ver MX records obtenidos del autoritativo o cach√© de 8.8.8.8.
- `dig +short ns ejemplo.com` ‚Üí lista de NS.

**Salida t√≠pica de `dig` (explicaci√≥n breve):**

- **QUESTION SECTION**: lo que preguntaste.
- **ANSWER SECTION**: registros contestados (A/AAAA/MX...).
- **AUTHORITY SECTION**: servidores autoritativos indicados (si la respuesta vino de cache o falta de datos).
- **ADDITIONAL SECTION**: registros adicionales (ej. A de los NS).

**nslookup** es m√°s simple pero menos completo; `nslookup -type=mx ejemplo.com` devuelve MX.

### 12) Tipos de consultas DNS

- **Recursiva**: el resolver devuelve la respuesta final (la habitual para clientes).
- **Iterativa**: el servidor devuelve una referencia a otro servidor; el solicitante debe continuar (paso a paso).
- **No-recursiva / cache-only**: pedir a un autoritativo o a un recursor que no haga trabajo adicional.
- **Inversa**: `PTR` para IP‚Üínombre.
- **Axfr/Ixfr**: transferencia de zona (entre servidores autoritativos).

### 13) Problemas comunes y troubleshooting r√°pido

- **Respuesta NXDOMAIN** ‚Üí el nombre no existe (comprueba SOA/NS y spelling).
- **Nombre resuelve a IP vieja** ‚Üí TTL largo o cache en alg√∫n resolutor; cambiar el TTL antes de un cambio planificado.
- **Servidores autoritativos no responden** ‚Üí verificar firewall, puertos UDP/TCP 53 abiertos y que NS apunten correctamente en el registro del dominio.
- **Problemas con correo (MX)** ‚Üí comprobar registros MX y su A/AAAA, PTR para la IP del servidor de correo (mapeo inverso).
- **`dig +trace`** y `dig @autoritativo` sirven para aislar problemas (si autoritativo responde bien, problema es recursor/cach√©).

### 14) Seguridad: riesgos y mitigaciones (resumen)

**Riesgos:**

- **Cache poisoning / spoofing** (ej. ataques que inyectan respuestas falsas).
- **DDoS a servidores DNS** (amplificaci√≥n de DNS, floods UDP).
- **Rogue DNS** (servidores maliciosos en red local).
- **NXDOMAIN floods / reflection attacks.**

**Mitigaciones:**

- **DNSSEC** para proteger integridad de datos.
- **Source port randomization** y 16-bit ID para dificultar inyecci√≥n.
- **Rate limiting** y **response rate limiting (RRL)** para mitigar amplificaci√≥n.
- **Anycast** + redes distribuidas para resiliencia (CDNs usan Anycast para resolver geogr√°ficamente).
- **RPZ (Response Policy Zones)** para filtrar dominios maliciosos.
- **Monitoreo & logging** (query logs, query rate, anomal√≠as).
- **DHCP/DNS integration / DHCP snooping** en LAN para reducir rogue DNS en entornos locales.
- **Split-horizon / views** para servir respuestas distintas en funci√≥n del origen (interno vs p√∫blico).

> Nota: describo ataques para promover defensas; no doy pasos para explotarlos.

### 15) Arquitecturas habituales

- **Resolver recursivo + caching**: ISP o resolver p√∫blico (Google/Cloudflare).
- **Autoritativo primario/secundario**: redundancia con zonas replicadas.
- **Anycasted authoritative/recursive**: misma IP anunciada desde m√∫ltiples ubicaciones para baja latencia y tolerancia.
- **Forwarder**: resolvers locales que reenv√≠an a otros resolvers (√∫til en empresas).
- **Split-horizon (views)**: respuestas distintas seg√∫n origen del request (VPN/interno vs Internet).

### 16) Buenas pr√°cticas (r√°pido)

- Definir TTLs adecuados (bajo para cambios frecuentes, alto para estabilidad).
- Usar **al menos dos NS autoritativos en distintas redes/geolocalizaciones**.
- Habilitar **DNSSEC** cuando es posible y mantener claves actualizadas.
- Proteger el acceso a transferencias de zona (AXFR) y usar TSIG si es necesario.
- Monitorizar latencia y tasas de error; configurar alertas.
- Evitar `CNAME` en la ra√≠z del dominio (aplica restricciones t√©cnicas).
- Mantener sincronizado SOA serial y usar notificaciones `NOTIFY` para propagaci√≥n.

### 17) Mini-cheat-sheet de comandos √∫tiles

- `dig www.ejemplo.com` ‚Äî consulta A por defecto.
- `dig +short www.ejemplo.com` ‚Äî solo la IP.
- `dig +trace www.ejemplo.com` ‚Äî seguimiento completo desde la ra√≠z.
- `dig @ns1.ejemplo.com ejemplo.com SOA` ‚Äî preguntar directamente al autoritativo.
- `nslookup -type=mx ejemplo.com` ‚Äî ver MX.
- `host 93.184.216.34` ‚Äî consulta inversa/ptr.
- Windows: `ipconfig /displaydns` (mostrar cach√© local), `nslookup`.
- Linux (systemd-resolved): `resolvectl query ejemplo.com` o `systemd-resolve --status`.

### 18) Resumen final (lo esencial para llevar a la pr√°ctica)

- DNS convierte nombres amigables en direcciones y otros metadatos; es jer√°rquico y cacheado.
- Para resolver un dominio un resolver recursivo pregunta a root ‚Üí TLD ‚Üí autoritativo; guarda resultado por TTL.
- Archivos de zona (SOA, NS, A, MX, CNAME, TXT, PTR, etc.) describen la informaci√≥n autoritativa.
- Seguridad y disponibilidad se logran con **DNSSEC, Anycast, rate limiting, monitoreo y buenas pr√°cticas de configuraci√≥n**.
- Herramientas como `dig` permiten diagnosticar y seguir la resoluci√≥n paso a paso.

---

[üîº](#√≠ndice)

---

| **Inicio**         | **atr√°s 10**         | **Siguiente 12**    |
| ------------------ | -------------------- | ------------------- |
| [üè†](../README.md) | [‚è™](./4_10_DHCP.md) | [‚è©](./4_12_NAT.md) |
