| **Inicio**         | **atrás 10**         | **Siguiente 12**    |
| ------------------ | -------------------- | ------------------- |
| [🏠](../README.md) | [⏪](./4_10_DHCP.md) | [⏩](./4_12_NAT.md) |

---

## **Índice**

| Temario                                |
| -------------------------------------- |
| [96. ¿Qué es DNS?](#96-qué-es-dns)     |
| [97. DNS explicado](#97-dns-explicado) |

# **DNS**

## **96. ¿Qué es DNS?**

![DHCP](/img/4_IP_Terminology/DNS.png "DHCP")

### 1. ¿Qué es DNS?

**DNS (Domain Name System)** es el sistema que traduce **nombres de dominio** fáciles de recordar (como `google.com`) en **direcciones IP** (como `142.250.72.206`) que las computadoras necesitan para comunicarse en Internet.

👉 **Ejemplo real**:

Cuando escribes `www.wikipedia.org` en tu navegador, DNS se encarga de encontrar la IP de los servidores de Wikipedia para que tu navegador pueda cargar la página.

Se le conoce como la **“guía telefónica de Internet”**, porque convierte nombres en números.

### 2. ¿Cómo funciona DNS?

El funcionamiento de DNS se basa en un **proceso de consulta y respuesta** entre varios servidores.

Cuando un usuario escribe una URL, el sistema sigue estos pasos:

1. El navegador pregunta: “¿Cuál es la IP de `www.wikipedia.org`?”
2. La petición pasa por distintos servidores DNS hasta obtener la respuesta.
3. El navegador se conecta al servidor web usando la IP recibida.

### 3. Los 4 servidores DNS que intervienen al cargar un sitio web

Cada búsqueda DNS involucra **hasta cuatro tipos de servidores**:

1. **Servidor recursivo (resolver)**

   - Es el primero que recibe la solicitud del cliente (PC, móvil, router).
   - Si tiene la respuesta en su caché, la devuelve al instante.
   - Ejemplos: servidores DNS de Google (`8.8.8.8`), Cloudflare (`1.1.1.1`), o los del ISP.

2. **Servidor raíz (root server)**

   - Hay 13 grupos de servidores raíz en todo el mundo.
   - Responden: “No sé la IP de `wikipedia.org`, pero sé qué servidores manejan `.org`”.

3. **Servidor TLD (Top-Level Domain)**

   - Maneja dominios de nivel superior, como `.com`, `.org`, `.net`.
   - Ejemplo: para `wikipedia.org`, el servidor TLD `.org` responde: “Pregunta a los servidores autoritativos de `wikipedia.org`”.

4. **Servidor autoritativo**

   - Tiene la información definitiva del dominio (`wikipedia.org`).
   - Devuelve la IP correcta del servidor web.

👉 Diagrama simple:

```
Cliente (PC)
   ↓
Servidor Recursivo
   ↓
Servidor Raíz
   ↓
Servidor TLD (.org)
   ↓
Servidor Autoritativo (wikipedia.org)
   ↓
IP final → Navegador carga el sitio
```

### 4. Diferencia entre **servidor DNS autoritativo** y **resolución recursiva**

- **Servidor autoritativo**:

  - Contiene la **respuesta oficial** de un dominio.
  - Ejemplo: Los servidores autoritativos de `wikipedia.org` saben la IP de `www.wikipedia.org`.

- **Resolución recursiva (resolver)**:

  - Es el “intermediario” que hace todo el trabajo de preguntar a raíz, TLD y autoritativos.
  - Ejemplo: Cuando usas `8.8.8.8`, Google DNS hace la resolución recursiva por ti.

👉 En resumen:

- El **recursivo** busca respuestas.
- El **autoritativo** da la respuesta final.

### 5. Pasos en una búsqueda DNS

1. Escribes `www.wikipedia.org` en el navegador.
2. El **resolver** (ej. `8.8.8.8`) recibe la consulta.
3. Si no está en caché, pregunta al **servidor raíz**.
4. El servidor raíz responde: “Busca en los servidores `.org`”.
5. El resolver pregunta al **servidor TLD `.org`**.
6. El TLD responde: “Pregunta a los servidores autoritativos de `wikipedia.org`”.
7. El resolver consulta al **autoritativo de wikipedia.org**.
8. El autoritativo responde con la IP (`208.80.154.224`).
9. El resolver guarda la respuesta en caché y la devuelve al navegador.
10. El navegador ya sabe a qué IP conectarse.

### 6. ¿Qué es una resolución de DNS?

La **resolución de DNS** es el proceso de convertir un **nombre de dominio en una dirección IP** mediante consultas entre los servidores mencionados.

Existen dos modos principales:

- **Resolución recursiva**: el resolver hace todas las preguntas y devuelve la respuesta final.
- **Resolución iterativa**: el resolver devuelve “pistas” y el cliente continúa preguntando (menos común en usuarios finales).

### 7. Tipos de consultas de DNS

1. **Consulta recursiva**:

   - El cliente pide al servidor recursivo que obtenga la respuesta completa.
   - Ejemplo: Tu PC pide a `8.8.8.8` la IP de `google.com`.

2. **Consulta iterativa**:

   - El servidor responde con la mejor información que tiene, aunque no sea la IP final.
   - Ejemplo: El servidor raíz responde con la dirección de un servidor TLD, no con la IP final.

3. **Consulta inversa (Reverse DNS Lookup)**:

   - Traduce una dirección IP en un nombre de dominio.
   - Ejemplo: `8.8.8.8` → `dns.google`.

### 8. ¿Qué es el caché de DNS? ¿Dónde se produce?

El **caché DNS** es el almacenamiento temporal de respuestas DNS para acelerar futuras consultas.

Se produce en varios niveles:

- **Caché del sistema operativo** (Windows, Linux, macOS).

  - Ejemplo: `ipconfig /displaydns` en Windows.

- **Caché del navegador** (Chrome, Firefox).

  - Ejemplo: Chrome tiene `chrome://net-internals/#dns`.

- **Caché en el resolver** (ej. `8.8.8.8`).
- **Caché en el propio servidor autoritativo** (dependiendo del TTL configurado).

👉 **Ejemplo práctico**:

Si visitas `wikipedia.org` y luego lo visitas de nuevo, tu sistema operativo probablemente ya tenga la IP en caché, así que no repite todo el proceso con los servidores raíz/TLD.

✅ **En resumen**:

- DNS traduce nombres ↔ IPs.
- Involucra **4 servidores**: recursivo, raíz, TLD y autoritativo.
- Las consultas pueden ser recursivas, iterativas o inversas.
- El **caché** hace que Internet sea mucho más rápido, guardando respuestas anteriores.

---

[🔼](#índice)

---

## **97. DNS explicado**

### 1) ¿Qué es DNS (en una frase)?

**DNS** es el sistema distribuido que traduce **nombres de dominio legibles** (por ejemplo `www.ejemplo.com`) en **direcciones IP** (por ejemplo `93.184.216.34`) — y también proporciona otros metadatos (correo, servidores autoritativos, políticas, etc.). Piensa en DNS como la guía telefónica de Internet.

### 2) Jerarquía y componentes principales

DNS es **jerárquico y delegable**. Niveles clave:

- **Resolver (stub resolver)**: componente del cliente (SO, navegador) que inicia la consulta.
- **Servidor recursivo (resolver recursivo)**: servidor al que el cliente pide la respuesta completa (ej. `8.8.8.8`, `1.1.1.1`, o los del ISP).
- **Servidores raíz (root servers)**: punto de partida; conocen los servidores TLD (existen 13 conjuntos lógicos: A–M).
- **Servidores TLD**: manejan `.com`, `.org`, `.es`, etc.; devuelven los servidores autoritativos para el dominio.
- **Servidores autoritativos**: contienen los registros reales (A, MX, NS, SOA...) para un dominio.
- **Registrador / Registry**: quien gestiona el dominio (registro) y las delegaciones NS en el TLD.

### 3) Tipos de registros DNS (los más usados) — con ejemplos

- **A** → IPv4. `www.ejemplo.com. 3600 IN A 93.184.216.34`
- **AAAA** → IPv6. `www.ejemplo.com. 3600 IN AAAA 2606:2800:220:1:248:1893:25c8:1946`
- **CNAME** → alias. `blog.ejemplo.com. 3600 IN CNAME ghs.googlehosted.com.`
- **MX** → mail exchangers (prioridad).
  `ejemplo.com. 3600 IN MX 10 mail.ejemplo.com.`
- **NS** → servidores autoritativos del dominio.
  `ejemplo.com. 3600 IN NS ns1.proveedor.net.`
- **SOA** → Start Of Authority (metadatos del zona: serial, refresh, retry, expire, minimum TTL).
- **PTR** → apuntador para **reverse DNS** (IP → nombre).
  `34.216.184.93.in-addr.arpa. 86400 IN PTR server.ejemplo.com.`
- **TXT** → texto arbitrario (SPF, verificación, DKIM).
- **SRV** → servicios (úsos de SIP, LDAP, etc.).
- **CAA** → define qué CA puede emitir certificados TLS para el dominio.

### 4) ¿Cómo funciona la resolución DNS? (proceso paso a paso)

Supongamos que tu navegador necesita la IP de `www.ejemplo.com`. Resumen del flujo (modo **recursivo**, que usa la mayoría de clientes):

1. **Cliente** (stub resolver) pregunta al **resolver recursivo** (p. ej. servidor del ISP o `8.8.8.8`): “¿cuál es la IP de `www.ejemplo.com`?”
2. El recursivo revisa su **caché**. Si no hay respuesta:
3. Pregunta al **servidor raíz**: “¿quién conoce `.com`?” → raíz responde con la lista de servidores TLD `.com`.
4. El recursivo pregunta a uno de los **TLD**: “¿quién es autoritativo para `ejemplo.com`?” → el TLD responde con los **NS autoritativos** para `ejemplo.com`.
5. El recursivo pregunta al **autoritativo**: “¿qué A/AAAA tiene `www.ejemplo.com`?” → el autoritativo responde con la IP (y TTL).
6. El recursivo guarda la respuesta en caché (por el TTL) y se la devuelve al cliente.
7. El cliente conecta a la IP recibida.

Diagrama simplificado:

```
Cliente → Resolver recursivo → Root → TLD → Autoritativo → (respuesta vuelta)
```

**Iterativa vs recursiva:**

- En **recursiva**, el resolver hace todas las preguntas por ti y retorna la respuesta final.
- En **iterativa**, el cliente recibe punteros y debe preguntar sucesivamente (más habitual en servidores entre sí o en demostraciones, no en el uso diario).

### 5) Puertos y transporte

- **UDP 53** para la mayoría de consultas (rápido, stateless).
- **TCP 53** se usa cuando: la respuesta supera el tamaño UDP, para transferencias de zona (AXFR) o para conexiones exigentes (DNS sobre TCP es fallback).
- **DoT (DNS over TLS, TCP 853)** y **DoH (DNS over HTTPS, TCP/443)**: versiones cifradas y privada de resolución de DNS.

### 6) Caché DNS: qué es, dónde ocurre y TTL

- **TTL (Time To Live)**: tiempo (segundos) que la respuesta será considerada válida en caché. El autoritativo establece el TTL.
- **¿Dónde se cachea?**

  - **Resolver recursivo** (ISP, Google DNS, Cloudflare) — el lugar más relevante para rendimiento.
  - **Sistema operativo** (ej.: `systemd-resolved`, `nscd` o Windows DNS Client).
  - **Navegador** (Chrome, Firefox) mantiene su propio caché DNS.
  - **Dispositivos intermedios** (caching DNS forwarders como `dnsmasq`) y proxies.

- **Ejemplo:** si A record para `www.ejemplo.com` tiene `TTL 3600`, el resolver lo guardará 1 hora. Antes de expirar, futuras peticiones usan cache y evitan consultas hacia root/TLD/autoritativo.

### 7) Archivos de zona / ejemplo práctico (BIND-style)

Archivo de zona `ejemplo.com.db` simplificado:

```
$TTL 3600
@   IN SOA  ns1.proveedor.net. hostmaster.ejemplo.com. (
        2024080101 ; serial YYYYMMDDnn
        3600       ; refresh
        900        ; retry
        604800     ; expire
        86400      ; minimum/negative TTL
)
    IN NS   ns1.proveedor.net.
    IN NS   ns2.proveedor.net.

; Registros A / AAAA
@   IN A    93.184.216.34
www IN A    93.184.216.34
@   IN AAAA 2606:2800:220:1::1946

; MX
@   IN MX 10 mail.ejemplo.com.
mail IN A   93.184.216.40

; CNAME
blog IN CNAME ghs.googlehosted.com.

; TXT (SPF)
@   IN TXT "v=spf1 mx -all"
```

- **SOA**: control de la zona; `serial` se incrementa cuando actualizas la zona.
- **NS**: delegación del dominio.
- **A/AAAA**: apuntan host → IP.
- **MX**: servidores de correo.
- **CNAME**: alias (no mezclar CNAME y otros registros en la misma etiqueta).

### 8) Reverse DNS (PTR) — ejemplo

Para la IP `93.184.216.34`, la búsqueda inversa consulta `34.216.184.93.in-addr.arpa.` y el PTR podría apuntar a `www.ejemplo.com.`. Los bloques IPv6 usan `ip6.arpa.` con nibbles invertidos.

### 9) DNSSEC (breve)

- DNSSEC añade **firmas digitales** a los registros: **DNSKEY**, **RRSIG**, **DS**.
- Objetivo: garantizar **integridad y autenticidad** de las respuestas DNS (proteger contra cache poisoning / spoofing).
- Concepto: la zona publica sus claves; el parent (.com) contiene un **DS** para enlazar la cadena de confianza hasta la raíz.

### 10) Delegación, zonas y transferencia

- **Delegación**: TLD apunta a tus nameservers (NS).
- **AXFR / IXFR**: transferencias de zona entre primario y secundarios (TCP 53).
- Los secundarios obtienen la zona del primario usando AXFR/IXFR o notificaciones (NOTIFY).

### 11) Comandos prácticos: `dig` y `nslookup` (con ejemplos)

**a)** `dig @resolver www.ejemplo.com A`

- `@resolver` es opcional; si no, usa default.
- `+short` muestra solo la IP.
- `+trace` sigue la resolución desde la raíz (útil para ver paso a paso).

**Ejemplo de uso y qué ver:**

- `dig www.ejemplo.com +trace` → verás consultas a root → TLD → autoritativo.
- `dig @8.8.8.8 example.com MX` → ver MX records obtenidos del autoritativo o caché de 8.8.8.8.
- `dig +short ns ejemplo.com` → lista de NS.

**Salida típica de `dig` (explicación breve):**

- **QUESTION SECTION**: lo que preguntaste.
- **ANSWER SECTION**: registros contestados (A/AAAA/MX...).
- **AUTHORITY SECTION**: servidores autoritativos indicados (si la respuesta vino de cache o falta de datos).
- **ADDITIONAL SECTION**: registros adicionales (ej. A de los NS).

**nslookup** es más simple pero menos completo; `nslookup -type=mx ejemplo.com` devuelve MX.

### 12) Tipos de consultas DNS

- **Recursiva**: el resolver devuelve la respuesta final (la habitual para clientes).
- **Iterativa**: el servidor devuelve una referencia a otro servidor; el solicitante debe continuar (paso a paso).
- **No-recursiva / cache-only**: pedir a un autoritativo o a un recursor que no haga trabajo adicional.
- **Inversa**: `PTR` para IP→nombre.
- **Axfr/Ixfr**: transferencia de zona (entre servidores autoritativos).

### 13) Problemas comunes y troubleshooting rápido

- **Respuesta NXDOMAIN** → el nombre no existe (comprueba SOA/NS y spelling).
- **Nombre resuelve a IP vieja** → TTL largo o cache en algún resolutor; cambiar el TTL antes de un cambio planificado.
- **Servidores autoritativos no responden** → verificar firewall, puertos UDP/TCP 53 abiertos y que NS apunten correctamente en el registro del dominio.
- **Problemas con correo (MX)** → comprobar registros MX y su A/AAAA, PTR para la IP del servidor de correo (mapeo inverso).
- **`dig +trace`** y `dig @autoritativo` sirven para aislar problemas (si autoritativo responde bien, problema es recursor/caché).

### 14) Seguridad: riesgos y mitigaciones (resumen)

**Riesgos:**

- **Cache poisoning / spoofing** (ej. ataques que inyectan respuestas falsas).
- **DDoS a servidores DNS** (amplificación de DNS, floods UDP).
- **Rogue DNS** (servidores maliciosos en red local).
- **NXDOMAIN floods / reflection attacks.**

**Mitigaciones:**

- **DNSSEC** para proteger integridad de datos.
- **Source port randomization** y 16-bit ID para dificultar inyección.
- **Rate limiting** y **response rate limiting (RRL)** para mitigar amplificación.
- **Anycast** + redes distribuidas para resiliencia (CDNs usan Anycast para resolver geográficamente).
- **RPZ (Response Policy Zones)** para filtrar dominios maliciosos.
- **Monitoreo & logging** (query logs, query rate, anomalías).
- **DHCP/DNS integration / DHCP snooping** en LAN para reducir rogue DNS en entornos locales.
- **Split-horizon / views** para servir respuestas distintas en función del origen (interno vs público).

> Nota: describo ataques para promover defensas; no doy pasos para explotarlos.

### 15) Arquitecturas habituales

- **Resolver recursivo + caching**: ISP o resolver público (Google/Cloudflare).
- **Autoritativo primario/secundario**: redundancia con zonas replicadas.
- **Anycasted authoritative/recursive**: misma IP anunciada desde múltiples ubicaciones para baja latencia y tolerancia.
- **Forwarder**: resolvers locales que reenvían a otros resolvers (útil en empresas).
- **Split-horizon (views)**: respuestas distintas según origen del request (VPN/interno vs Internet).

### 16) Buenas prácticas (rápido)

- Definir TTLs adecuados (bajo para cambios frecuentes, alto para estabilidad).
- Usar **al menos dos NS autoritativos en distintas redes/geolocalizaciones**.
- Habilitar **DNSSEC** cuando es posible y mantener claves actualizadas.
- Proteger el acceso a transferencias de zona (AXFR) y usar TSIG si es necesario.
- Monitorizar latencia y tasas de error; configurar alertas.
- Evitar `CNAME` en la raíz del dominio (aplica restricciones técnicas).
- Mantener sincronizado SOA serial y usar notificaciones `NOTIFY` para propagación.

### 17) Mini-cheat-sheet de comandos útiles

- `dig www.ejemplo.com` — consulta A por defecto.
- `dig +short www.ejemplo.com` — solo la IP.
- `dig +trace www.ejemplo.com` — seguimiento completo desde la raíz.
- `dig @ns1.ejemplo.com ejemplo.com SOA` — preguntar directamente al autoritativo.
- `nslookup -type=mx ejemplo.com` — ver MX.
- `host 93.184.216.34` — consulta inversa/ptr.
- Windows: `ipconfig /displaydns` (mostrar caché local), `nslookup`.
- Linux (systemd-resolved): `resolvectl query ejemplo.com` o `systemd-resolve --status`.

### 18) Resumen final (lo esencial para llevar a la práctica)

- DNS convierte nombres amigables en direcciones y otros metadatos; es jerárquico y cacheado.
- Para resolver un dominio un resolver recursivo pregunta a root → TLD → autoritativo; guarda resultado por TTL.
- Archivos de zona (SOA, NS, A, MX, CNAME, TXT, PTR, etc.) describen la información autoritativa.
- Seguridad y disponibilidad se logran con **DNSSEC, Anycast, rate limiting, monitoreo y buenas prácticas de configuración**.
- Herramientas como `dig` permiten diagnosticar y seguir la resolución paso a paso.

---

[🔼](#índice)

---

| **Inicio**         | **atrás 10**         | **Siguiente 12**    |
| ------------------ | -------------------- | ------------------- |
| [🏠](../README.md) | [⏪](./4_10_DHCP.md) | [⏩](./4_12_NAT.md) |
