| **Inicio**         | **atr√°s 11**        | **Siguiente 13**   |
| ------------------ | ------------------- | ------------------ |
| [üè†](../README.md) | [‚è™](./4_11_DNS.md) | [‚è©](./4_13_IP.md) |

---

## **√çndice**

| Temario                                        |
| ---------------------------------------------- |
| [98. C√≥mo funciona NAT](#98-c√≥mo-funciona-nat) |
| [99. NAT explicado](#99-nat-explicado)         |

# **NAT**

## **98. C√≥mo funciona NAT**

![NAT](/img/4_IP_Terminology/NAT.jpg "NAT")

### 1) ¬øQu√© es NAT y por qu√© se usa?

**NAT (Network Address Translation)** es una t√©cnica que **traduce direcciones IP/puertos** entre una red interna (privada) y otra externa (p√∫blica).

Motivos principales:

- **Escasez de IPv4** ‚Üí permite que m√∫ltiples hosts privados (ej. 192.168.x.x) compartan una o pocas direcciones IPv4 p√∫blicas.
- **Seguridad/encapsulamiento** ‚Üí oculta direcciones internas desde Internet.
- **Flexibilidad de direccionamiento** ‚Üí puedes renumerar internamente sin cambiar IPs p√∫blicas.

Ejemplo t√≠pico: en una red dom√©stica `192.168.1.0/24` todos los equipos salen a Internet usando la IP p√∫blica del router `203.0.113.5`.

### 2) Tipos de NAT (resumen r√°pido)

1. **Static NAT (One-to-One)** ‚Äî mapea una IP p√∫blica a una IP privada fija.
2. **Dynamic NAT (Pool)** ‚Äî mapea internos a un _pool_ de IPs p√∫blicas (uno-a-uno, din√°mico).
3. **PAT / NAT Overload (Port Address Translation)** ‚Äî varios internos comparten **una** IP p√∫blica usando distintos **puertos** (lo m√°s com√∫n en hogares). Tambi√©n llamado **masquerade**.
4. **Destination NAT (DNAT / Port Forwarding)** ‚Äî redirige tr√°fico entrante desde IP/puerto p√∫blico a host/puerto interno.
5. **Twice NAT / Source/Destination NAT** ‚Äî modificaci√≥n simult√°nea de IP origen y destino (raro, usado en pol√≠ticas avanzadas).
6. **NAT64 / DNS64** ‚Äî traducci√≥n entre IPv6/IPv4 para comunicar redes mixtas.

### 3) ¬øC√≥mo funciona NAT? (mec√°nica y tabla de traducci√≥n)

- NAT mantiene una **tabla de traducci√≥n** (connection table) con entradas tipo _tupla_:

  ```
  (IP_origen_priv, puerto_origen_priv, IP_destino, puerto_destino) ‚Üî (IP_origen_pub, puerto_origen_pub)
  ```

- Cuando un paquete sale de la LAN al Internet, el router:

  1. **Reescribe** la IP de origen (y si aplica, el puerto) por la IP p√∫blica (y puerto asignado).
  2. Crea una **entrada** en la tabla NAT asociando la conexi√≥n original con la traducci√≥n.
  3. Env√≠a el paquete hacia Internet.

- Cuando vuelve la respuesta, el router consulta su tabla NAT y **deshace** la traducci√≥n (re-escribe destino hacia la IP privada correcta) y reenv√≠a al host interno.

Eso permite multiplexar muchas conexiones internas sobre una IP p√∫blica usando puertos.

### 4) Flujo b√°sico con ejemplo num√©rico (PAT)

Red: `192.168.1.0/24` ‚Üí router con IP p√∫blica `203.0.113.5`.

- Host interno: `192.168.1.100:45321` ‚Üí quiere HTTP (dport 80) a `93.184.216.34:80`.
- Router NAT cambia origen a `203.0.113.5:54321` (ejemplo) y registra:

  ```
  NAT entry:
  inside: 192.168.1.100:45321 -> outside: 203.0.113.5:54321  (dst 93.184.216.34:80)
  ```

- Servidor remoto responde a `203.0.113.5:54321`.
- Router busca la entrada y entrega al host original `192.168.1.100:45321`.

Diagrama ASCII:

```
192.168.1.100:45321 --> [NAT router (203.0.113.5:54321)] --> 93.184.216.34:80
                                     ^                             |
                                     |<-- respuesta -- -------------|
```

### 5) Ejemplos de configuraci√≥n ‚Äî comandos reales

#### A) Cisco IOS ‚Äî marcar inside/outside y PAT (overload)

```text
! Interfaces
interface Gig0/0
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
!
interface Gig0/1
 ip address 203.0.113.5 255.255.255.0
 ip nat outside

! Access-list para rango interno
access-list 1 permit 192.168.1.0 0.0.0.255

! PAT: todos los hosts del ACL 1 usan la interfaz Gig0/1 (IP 203.0.113.5) sobrecargando puertos
ip nat inside source list 1 interface Gig0/1 overload

! Static NAT ejemplo (mapeo 1:1)
ip nat inside source static 192.168.1.20 203.0.113.10

! Port forward (DNAT) ejemplo: p√∫blico 203.0.113.5:8080 -> 192.168.1.20:80
ip nat inside source static tcp 192.168.1.20 80 203.0.113.5 8080
```

#### B) Linux ‚Äî iptables (iptables-legacy; para nftables la idea es similar)

Permitir salida y NAT (masquerade) en interfaz `eth0` (WAN):

```bash
# Habilitar forwarding en kernel
sudo sysctl -w net.ipv4.ip_forward=1

# Masquerade (PAT) ‚Äî t√≠pico en routers dom√©sticos
sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# Port forwarding (DNAT): WAN eth0 puerto 8080 -> 192.168.1.20:80
sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.20:80
sudo iptables -A FORWARD -p tcp -d 192.168.1.20 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT

# SNAT est√°tico (si tienes IP p√∫blica fija)
sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 203.0.113.5
```

**MASQUERADE** vs **SNAT**: `MASQUERADE` detecta IP p√∫blica din√°mica (ISP cambia IP). `SNAT --to-source` para IP p√∫blica fija (m√°s eficiente).

#### C) AWS (NAT Gateway)

- Arquitectura: Private Subnet ‚Üí Route table (0.0.0.0/0 -> NAT Gateway in Public Subnet) ‚Üí NAT Gateway ‚Üí Internet Gateway.
- El NAT Gateway permite que instancias en subred privada salgan a Internet sin tener IP p√∫blica.

### 6) DNAT / Port Forwarding (caso de servidor p√∫blico detr√°s de NAT)

Escenario: quieres publicar un servidor web interno `192.168.1.20:80` usando la IP p√∫blica `203.0.113.5:8080`.

- **DNAT / Port forward** en PREROUTING: reescribe destino (dst) al host interno.
- Debes permitir el FORWARD y normalmente configurar hairpin NAT si hosts internos usan la IP p√∫blica para acceder.

Ejemplo (iptables ya mostrado arriba).

### 7) Hairpin (NAT reflection) ‚Äî acceso interno usando IP p√∫blica

Si un cliente interno intenta acceder a `203.0.113.5:8080` (la IP p√∫blica), el router debe **volver a dirigir** esa conexi√≥n hacia `192.168.1.20`. Esto se llama _hairpin NAT_ o _NAT reflection_ y requiere reglas adicionales (DNAT+SNAT) porque el host interno espera respuesta desde IP p√∫blica.

### 8) Estado/connection tracking y timeouts

- NAT est√° **stateful**: registra conexiones (TCP/UDP) y las mantiene mientras haya actividad.
- **Timeouts**: entradas se eliminan tras un tiempo (p. ej. UDP cortos, TCP m√°s largos hasta FIN/timeout). En Linux `conntrack` muestra y permite modificar timeouts.
- Comando √∫til (Linux): `sudo conntrack -L` o `sudo apt install conntrack` y `conntrack -L`.

### 9) Limitaciones y problemas comunes

- **Rompimiento del principio end-to-end**: aplicaciones que suponen direcciones IP finales pueden fallar (p. ej. protocolos que incluyen IP en payload).
- **Protocolos que ‚Äúembeben‚Äù IP/puertos**: FTP (active mode), SIP, H.323, some VPNs ‚Üí necesitan **ALGs** o inspecci√≥n de aplicaci√≥n.
- **Exhaustion de puertos**: cada IP p√∫blica tiene \~65k puertos (menos los reservados). Si tienes muchos clientes/conexiones concurrentes, puedes agotar las combinaciones fuente-puerto.
- **Doble NAT**: m√∫ltiples capas de NAT (ISP modem/router + tu router) complican port-forwarding y UPnP.
- **Dificultad para geolocalizaci√≥n** y control por IP (porque muchos usuarios comparten la misma IP p√∫blica).
- **Problemas con TLS client certs**? No con NAT en s√≠, pero si haces inspecci√≥n profunda puede interferir.

### 10) NAT y seguridad

- NAT **oculta** direcciones internas, pero **no es** un firewall ni sustituto de pol√≠ticas de filtrado.
- ALGs (Application Level Gateways) pueden ayudar a protocolos complejos, pero a veces introducen vulnerabilidades o complican el tr√°fico (mejor usar soluciones seguras y espec√≠ficas cuando sea necesario).
- Buenas pr√°cticas: combinar NAT con firewall stateful, logging de traducciones y l√≠mites de connections para mitigar abusos.

### 11) NAT traversal (c√≥mo funcionan aplicaciones P2P)

Para que dos hosts detr√°s de NAT se conecten directamente (p. ej. VoIP, juegos, WebRTC) se usan:

- **STUN** (descubre IP p√∫blica/puerto asignado).
- **TURN** (relay si no es posible conexi√≥n directa).
- **ICE** (coordina STUN/TURN y candidatos).
- **UPnP / PCP / NAT-PMP**: protocolo para que un host solicite al router abrir/forwardear puertos (automatiza port forwarding).
  Estas t√©cnicas permiten sortear restricciones impuestas por NAT.

### 12) NAT en IPv6 y NAT64

- **IPv6** pretende eliminar la necesidad de NAT (espacio de direcciones abundante). La recomendaci√≥n general: **no usar NAT en IPv6** para preservar end-to-end.
- **NAT64** / **DNS64**: herramientas para permitir que clientes IPv6 accedan a servicios IPv4 traduciendo direcciones/protocolos (√∫til durante transici√≥n IPv6).

### 13) Diagn√≥stico y comandos de troubleshooting

#### Cisco IOS

- `show ip nat translations` ‚Üí ver tabla de traducciones.
- `show ip nat statistics` ‚Üí estad√≠sticas y timeouts.
- `clear ip nat translation *` ‚Üí limpiar tabla (cuidado en prod).

#### Linux

- `iptables -t nat -L -n -v` ‚Üí ver reglas NAT.
- `sudo iptables -t nat -S` ‚Üí ver reglas en formato de comandos.
- `sudo conntrack -L` ‚Üí ver conexiones trackeadas.
- `tcpdump -i eth0 'tcp and host 93.184.216.34' -n` ‚Üí ver paquetes y comprobar cabeceras traducidas.
- `sysctl net.ipv4.ip_forward` ‚Üí validar forwarding activado.

#### Diagn√≥stico pr√°ctico

- Si un servicio publicado no responde desde Internet, prueba:

  1. ¬øReglas DNAT aplicadas? `iptables -t nat -L -n -v`.
  2. ¬øForwading permitido en firewall? `iptables -L FORWARD`.
  3. ¬øHost interno responde localmente? `curl http://192.168.1.20:80` desde el router.
  4. ¬øNAT table contiene entradas? `conntrack -L` o `show ip nat translations`.

### 14) Buenas pr√°cticas y recomendaciones

- Usa **IP p√∫blicas fijas** para servidores que necesitan reachability; coloca NAT est√°tico o asigna IP p√∫blica dedicada.
- **Evita doble NAT** cuando puedas (modo bridge o pedir modo puente al ISP).
- **Monitorea** la tabla NAT y la utilizaci√≥n de puertos; alerta por saturaci√≥n.
- Para VoIP/WebRTC, preferir **STUN/TURN** y controlar ALGs (muchos ALGs crean problemas).
- En cloud, usar **NAT Gateway** administrado (AWS/Azure) para salida desde subredes privadas, y **Elastic IPs** o balanceadores para servicios entrantes.
- Documenta tus reglas NAT y el mapeo entre IP p√∫blicas y privados (evita sorpresas).

### 15) Resumen (lo esencial)

- **NAT traduce IPs/puertos** entre redes, permitiendo compartir pocas IPs p√∫blicas entre muchos hosts privados.
- El **PAT/NAT Overload** (masquerade) es la forma m√°s com√∫n: muchos privados ‚Üí 1 p√∫blica v√≠a puertos.
- NAT funciona con una **tabla de traducci√≥n stateful** que mapea tuplas origen/destino.
- Existen variantes (DNAT, Static NAT, Dynamic NAT, NAT64) con usos concretos (publicar servicios, salida a Internet, permitir IPv6‚ÜîIPv4).
- NAT impone limitaciones (end-to-end, puertos finitos) y requiere combinarlas con firewall y buenas pr√°cticas.

---

[üîº](#√≠ndice)

---

## **99. NAT explicado**

### 1) ¬øQu√© es NAT y por qu√© se usa?

**NAT (Network Address Translation)** es la t√©cnica que **traduce direcciones IP (y a menudo puertos)** entre dos redes ‚Äînormalmente entre una red privada (LAN) y la red p√∫blica (Internet).

Motivos principales:

- **Escasez de IPv4**: permite que muchos hosts privados (ej. 192.168.x.x) compartan pocas direcciones p√∫blicas.
- **Ocultamiento**: las IP internas quedan ‚Äúocultas‚Äù tras la IP p√∫blica.
- **Flexibilidad de direccionamiento**: renumerar la red interna sin cambiar las IP p√∫blicas.

### 2) Tipos de NAT (concepto + cu√°ndo se usan)

1. **Static NAT (1:1)**

   - Mapea una IP privada a una IP p√∫blica fija.
   - Uso: servidor interno que debe ser accesible desde Internet (por ejemplo, 192.168.1.20 ‚Üî 203.0.113.10).

2. **Dynamic NAT (pool)**

   - Traduce IPs privadas a IPs p√∫blicas de un _pool_ disponible, asignaci√≥n din√°mica 1:1 mientras haya entradas libres.
   - Uso: redes con varias IPs p√∫blicas pero no suficientes para todos los hosts simult√°neamente.

3. **PAT / NAT Overload (port translation / masquerade)**

   - Muchos hosts internos _comparten una √∫nica_ IP p√∫blica diferenciando por puertos (source port). Es la forma m√°s com√∫n en hogares.
   - Ejemplo: 192.168.1.100:54321 ‚Üí 203.0.113.5:40001; 192.168.1.101:55211 ‚Üí 203.0.113.5:40002.

4. **DNAT (Destination NAT) / Port forwarding**

   - Traduce la direcci√≥n/puerto destino para publicar un servicio interno desde una IP p√∫blica (ej. 203.0.113.5:8080 ‚Üí 192.168.1.20:80).

5. **Twice NAT / Full NAT**

   - Modifica tanto origen como destino (usado en pol√≠ticas avanzadas).

6. **NAT64 / DNS64**

   - Traducci√≥n entre IPv6 e IPv4 para clientes IPv6 que necesitan acceder a servidores IPv4.

### 3) ¬øC√≥mo funciona NAT (mec√°nica interna)?

- NAT mantiene una **tabla de traducci√≥n** (stateful): cada entrada asocia la tupla interna (IP, puerto origen) con la tupla p√∫blica (IP, puerto traducido) y el destino.
- Flujo t√≠pico (PAT):

  1. **Host interno** crea conexi√≥n ‚Üí paquete con IP origen privada y puerto (ej. 192.168.1.100:45321).
  2. Router/NAT **reescribe** la IP origen por la IP p√∫blica (ej. 203.0.113.5) y probablemente cambia puerto (p. ej. 54321) ‚Äî a√±ade una entrada en la tabla NAT.
  3. Servidor remoto responde a 203.0.113.5:54321 ‚Üí router consulta la tabla NAT y reescribe destino a 192.168.1.100:45321 ‚Üí entrega al host interno.

**Entrada de tabla (ejemplo)**:

```
inside:  192.168.1.100:45321  ->  outside: 203.0.113.5:54321   (dst 93.184.216.34:80)
```

### 4) Ejemplo num√©rico paso a paso (PAT)

- Host A: `192.168.1.100:50000` ‚Üí quiere HTTP a `93.184.216.34:80`.
- Router NAT (IP p√∫blica `203.0.113.5`) asigna puerto local `62000`:

  - Traducci√≥n: `192.168.1.100:50000 -> 203.0.113.5:62000`.

- Servidor responde a `203.0.113.5:62000`.
- Router consulta tabla y entrega al host A `192.168.1.100:50000`.

### 5) Configuraci√≥n pr√°ctica (ejemplos)

#### A) Cisco IOS (resumen)

```text
! Interfaces
interface Gig0/0
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
!
interface Gig0/1
 ip address 203.0.113.5 255.255.255.0
 ip nat outside

! ACL que define la red interna
access-list 1 permit 192.168.1.0 0.0.0.255

! PAT: todos los hosts del ACL comparten la IP de la interfaz Gig0/1
ip nat inside source list 1 interface Gig0/1 overload

! Static NAT (ejemplo)
ip nat inside source static 192.168.1.20 203.0.113.10

! DNAT (port forward) p√∫blico 203.0.113.5:8080 -> 192.168.1.20:80
ip nat inside source static tcp 192.168.1.20 80 203.0.113.5 8080
```

#### B) Linux (iptables / nftables)

```bash
# Habilitar forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Masquerade (PAT) en eth0 (WAN)
sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# DNAT: publicar puerto 8080 -> 192.168.1.20:80
sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.20:80
sudo iptables -A FORWARD -p tcp -d 192.168.1.20 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
```

#### C) AWS (NAT Gateway, arquitectura)

- **Arquitectura t√≠pica**: Private Subnet ‚Üí Route (0.0.0.0/0 ‚Üí NAT Gateway in Public Subnet) ‚Üí NAT Gateway ‚Üí Internet Gateway.
- Instancias privadas salen con la IP el√°stica del NAT Gateway; servicios p√∫blicos se colocan en subred p√∫blica con Elastic IP o ALB.

### 6) NAT Reflection / Hairpin NAT

Cuando un host interno accede a la IP p√∫blica que est√° mapeada a un host interno (p. ej. `http://203.0.113.5:8080` desde 192.168.1.50), el router debe **redirigir internamente** esa conexi√≥n ‚Äî hairpin NAT. Requiere reglas DNAT + SNAT para que el servidor interno devuelva los paquetes correctamente al cliente interno.

### 7) NAT y protocolos problem√°ticos

- Algunos protocolos **‚Äúembeben‚Äù IPs/puertos en su payload** (FTP active, SIP, H.323, algunos juegos) y requieren **ALGs** (Application Layer Gateways) o proxies para reescribir esos payloads.
- ALGs pueden ayudar, pero en la pr√°ctica suelen causar problemas ‚Äî hoy d√≠a se prefieren soluciones espec√≠ficas (SIP aware SBCs, TURN para WebRTC).

### 8) NAT traversal (c√≥mo consiguen conectarse P2P y VoIP)

Para conexiones entrantes entre peers detr√°s de NAT existe un conjunto de t√©cnicas:

- **Full cone / restricted / symmetric NAT** ‚Äî comportamientos de NAT que determinan si una conexi√≥n directa es posible.
- **STUN** ‚Äî descubre la IP/puerto p√∫blico asignado por el NAT.
- **TURN** ‚Äî rel√© (si no puede haber conexi√≥n directa).
- **ICE** ‚Äî protocolo que coordina STUN/TURN y el establecimiento de la mejor ruta.
- **UPnP IGD / NAT-PMP / PCP** ‚Äî protocolos para que un host solicite autom√°ticamente al router abrir un puerto (auto port-forwarding).

### 9) Limitaciones y problemas comunes

- **Agotamiento de puertos**: una IP p√∫blica tiene \~65k puertos; con much√≠simas conexiones simult√°neas se puede agotar la combinaci√≥n IP\:puerto.
- **Doble NAT**: dos niveles de NAT (ISP + usuario) complican port-forwarding y traversal.
- **Ruptura end-to-end**: apps que asumen IP final/identidad se rompen.
- **Estado y timeouts**: entradas NAT caducan; paquetes entrantes sin entrada ser√°n descartados.
- **Problemas con TLS client-cert o inspecci√≥n profunda** si hay proxies intermedios.

### 10) Seguridad: NAT vs Firewall

- **NAT no es un firewall**, aunque por defecto facilita que tr√°fico entrante no solicitado no llegue a hosts internos.
- Recomendaci√≥n: **usar firewall stateful** adem√°s de NAT, establecer pol√≠ticas expl√≠citas, logging y monitoreo.
- No confiar en NAT como √∫nica protecci√≥n; auditar accesos, habilitar IPS/IDS y segmentation.

### 11) Diagn√≥stico y comandos √∫tiles

**Cisco**

- `show ip nat translations` ‚Äî ver tabla NAT
- `show ip nat statistics` ‚Äî estad√≠sticas (timeouts, entradas)
- `clear ip nat translation *` ‚Äî limpiar traducciones

**Linux**

- Ver reglas NAT: `sudo iptables -t nat -L -n -v`
- Ver conexiones trackeadas: `sudo conntrack -L` (instalar `conntrack-tools`)
- Ver forwarding y sysctl: `sysctl net.ipv4.ip_forward`

**Captura y pruebas**

- `tcpdump -i eth0 'tcp and host 93.184.216.34' -n` ‚Äî ver paquetes y cabeceras traducidas.
- Prueba de port-forward: desde Internet `curl http://203.0.113.5:8080` y luego `curl http://192.168.1.20:80` desde el router para aislar si el servicio responde localmente.

### 12) Buenas pr√°cticas

- **Evitar doble NAT** (pedir puente al ISP o usar modo bridge si necesitas port-forward).
- **Reservar IP p√∫blicas** para servicios que requieren reachability (static NAT).
- **Documentar** reglas NAT, mapeos y puertos abiertos.
- **Monitorizar** la tabla NAT para detectar saturaci√≥n y patrones an√≥malos.
- **Usar NAT Gateway administrado** en cloud para facilidad y escalado.
- **Preferir IPv6** cuando sea posible ‚Äî evita la mayor√≠a de problemas de NAT (no se recomienda NAT en IPv6).

### 13) Resumen r√°pido

- NAT **traduce** IPs/puertos entre zonas y es la soluci√≥n pr√°ctica ante la escasez IPv4 y para ocultar redes internas.
- **PAT** (masquerade) es el modo m√°s com√∫n: muchos internos ‚Üí 1 p√∫blica por puertos.
- Hay variantes (static, dynamic, DNAT, NAT64) seg√∫n necesidad.
- NAT introduce desaf√≠os (port exhaustion, traversal, doble NAT) y no sustituye a medidas de seguridad adecuadas.
- Diagn√≥stico: `show ip nat translations`, `iptables -t nat -L`, `conntrack -L`, `tcpdump`.

---

[üîº](#√≠ndice)

---

| **Inicio**         | **atr√°s 11**        | **Siguiente 13**   |
| ------------------ | ------------------- | ------------------ |
| [üè†](../README.md) | [‚è™](./4_11_DNS.md) | [‚è©](./4_13_IP.md) |
