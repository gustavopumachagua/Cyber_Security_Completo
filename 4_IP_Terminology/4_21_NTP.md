| **Inicio**         | **atrÃ¡s 20**         | **Siguiente 22**     |
| ------------------ | -------------------- | -------------------- |
| [ğŸ ](../README.md) | [âª](./4_20_WLAN.md) | [â©](./4_22_IPAM.md) |

---

## **Ãndice**

| Temario                                                                      |
| ---------------------------------------------------------------------------- |
| [120. Â¿QuÃ© es NTP?](#120-quÃ©-es-ntp)                                         |
| [121. Protocolo de tiempo de red (NTP)](#121-protocolo-de-tiempo-de-red-ntp) |

# **NTP**

## **120. Â¿QuÃ© es NTP?**

![NTP](/img/4_IP_Terminology/NTP.png "NTP")

El **Network Time Protocol (NTP)** es un protocolo de red que permite sincronizar el reloj de los dispositivos (servidores, routers, PCs, smartphones) con gran precisiÃ³n, generalmente con relojes de referencia como el **UTC (Tiempo Universal Coordinado)**.

ğŸ‘‰ Fue creado en los aÃ±os 80 por David L. Mills y es uno de los protocolos mÃ¡s antiguos aÃºn en uso en Internet.

ğŸ“Œ **Ejemplo sencillo:**

Cuando tu laptop marca las **11:59:50**, pero el servidor oficial UTC marca las **12:00:00**, NTP ajusta tu reloj automÃ¡ticamente para que coincidan.

### ğŸ”‘ Puntos clave sobre NTP

- Mantiene relojes sincronizados en **milisegundos** (en Internet) o incluso **microsegundos** (en redes locales).
- Funciona con el **puerto UDP 123**.
- Es un **protocolo jerÃ¡rquico**, basado en niveles llamados **stratum** (estratos).

ğŸ“Œ **Ejemplo de jerarquÃ­a de estratos (stratum):**

1. **Stratum 0:** Relojes atÃ³micos, GPS.
2. **Stratum 1:** Servidores directamente conectados a Stratum 0.
3. **Stratum 2:** Servidores sincronizados con Stratum 1.
4. **Stratum 3 en adelante:** Clientes o servidores que dependen de niveles superiores.

### ğŸ”„ Proceso bÃ¡sico de comunicaciÃ³n NTP

La sincronizaciÃ³n ocurre mediante un **intercambio de mensajes** entre cliente y servidor:

1. El cliente envÃ­a una solicitud NTP con la **hora en que saliÃ³ el mensaje**.
2. El servidor responde con:

   - La hora en que recibiÃ³ la solicitud.
   - La hora en que enviÃ³ la respuesta.

3. El cliente compara su reloj con el servidor y calcula:

   - **Desfase (offset):** Diferencia entre su hora y la del servidor.
   - **Retardo (delay):** Tiempo que tardÃ³ el mensaje en ir y volver.

ğŸ“Œ **Ejemplo prÃ¡ctico:**

- Tu PC envÃ­a una peticiÃ³n a `time.google.com`.
- El servidor dice: "RecibÃ­ tu mensaje a las 10:00:01.123 y te respondo a las 10:00:01.223".
- Tu PC corrige su hora considerando el tiempo de viaje.

### ğŸ§© Componentes clave de los mensajes NTP

Un mensaje NTP contiene varios campos importantes:

- **Transmit Timestamp:** Hora en que el cliente enviÃ³ el mensaje.
- **Receive Timestamp:** Hora en que el servidor lo recibiÃ³.
- **Transmit Timestamp del servidor:** Hora en que el servidor enviÃ³ la respuesta.
- **Originate Timestamp:** Copia de la hora original del cliente.

### ğŸ§® CÃ¡lculo del desfase y retardo

El cliente puede calcular:

- **Retardo (Round-Trip Delay):**

  $$
  delay = (T4 - T1) - (T3 - T2)
  $$

- **Desfase (Clock Offset):**

  $$
  offset = \frac{(T2 - T1) + (T3 - T4)}{2}
  $$

ğŸ“Œ Donde:

- T1 = Tiempo en que cliente enviÃ³ peticiÃ³n.
- T2 = Tiempo en que servidor recibiÃ³ peticiÃ³n.
- T3 = Tiempo en que servidor enviÃ³ respuesta.
- T4 = Tiempo en que cliente recibiÃ³ respuesta.

ğŸ‘‰ Esto asegura que se corrijan **retrasos de red**.

### âš™ï¸ Modos de operaciÃ³n

NTP puede trabajar en varios modos:

1. **Cliente-Servidor:** Un dispositivo consulta a un servidor NTP.
2. **Peer-to-Peer:** Dos dispositivos se sincronizan entre sÃ­.
3. **Broadcast/Multicast:** Un servidor anuncia la hora y mÃºltiples clientes la reciben.
4. **Symmetric:** Usado entre servidores para mayor precisiÃ³n.

ğŸ“Œ **Ejemplo:**

- Tu PC (cliente) consulta a `time.windows.com` (servidor).
- Varios routers en una empresa usan modo **broadcast** para que todos los PCs se sincronicen a la vez.

### ğŸ” Seguridad en NTP

NTP es vulnerable a:

- **Ataques de amplificaciÃ³n DDoS** (usando NTP mal configurado).
- **SuplantaciÃ³n de tiempo** (si un atacante envÃ­a respuestas falsas).

ğŸ‘‰ Para protegerse, se usan:

- **NTP con autenticaciÃ³n** (claves criptogrÃ¡ficas).
- **NTPsec** y **Chrony** (implementaciones mÃ¡s seguras y modernas).

### ğŸ–¥ï¸ ImplementaciÃ³n y uso

- Sistemas operativos modernos (Windows, Linux, macOS) ya incluyen soporte NTP.
- Servidores NTP pÃºblicos:

  - `time.google.com`
  - `time.windows.com`
  - `pool.ntp.org`

ğŸ“Œ **Ejemplo en Linux:**

```bash
sudo apt install ntp
ntpq -p
```

Esto muestra con quÃ© servidores NTP estÃ¡ sincronizado tu equipo.

### ğŸ“› Otros nombres para NTP

- **SNTP (Simple NTP):** VersiÃ³n mÃ¡s ligera y sencilla, usada en dispositivos pequeÃ±os (IoT, routers).
- **NTPv4:** VersiÃ³n mÃ¡s usada actualmente, compatible con IPv6.

### âœ… Resumen final

- **NTP** sincroniza relojes en red con precisiÃ³n milimÃ©trica.
- Usa **mensajes UDP en el puerto 123**.
- Calcula el **desfase y retardo** para ajustar la hora.
- Tiene varios **modos de operaciÃ³n** (cliente-servidor, broadcast, etc.).
- Es vital para **seguridad, logs, transacciones financieras, redes y comunicaciones**.

---

[ğŸ”¼](#Ã­ndice)

---

## **121. Protocolo de tiempo de red (NTP)**

### ğŸ•’ Â¿QuÃ© es el Protocolo de Tiempo de Red (NTP)?

El **NTP (Network Time Protocol)** es un protocolo que se usa en las redes para **sincronizar los relojes de los dispositivos** (computadoras, routers, servidores, mÃ³viles, etc.) con gran precisiÃ³n.

ğŸ‘‰ Se ejecuta sobre **UDP, puerto 123**, y puede mantener relojes sincronizados con una diferencia de **milisegundos en Internet** y hasta **microsegundos en redes locales**.

ğŸ“Œ **Ejemplo sencillo:**

- Si tu laptop marca las **08:59:57**, pero la hora oficial (UTC) es **09:00:00**, NTP corrige automÃ¡ticamente tu reloj para que coincida.

### ğŸ”‘ CaracterÃ­sticas clave de NTP

- Funciona en una **jerarquÃ­a de estratos (stratum)**:

  - **Stratum 0:** Relojes de referencia (GPS, relojes atÃ³micos).
  - **Stratum 1:** Servidores conectados directamente a Stratum 0.
  - **Stratum 2:** Servidores sincronizados con Stratum 1.
  - Y asÃ­ sucesivamente.

- Usa un sistema de cÃ¡lculo que tiene en cuenta el **retardo de red** para evitar errores de tiempo.

ğŸ“Œ **Ejemplo jerÃ¡rquico:**

- Un servidor Stratum 1 se conecta a un reloj GPS.
- Tu proveedor de Internet usa servidores Stratum 2.
- Tu PC se sincroniza con esos servidores.

### ğŸ”„ Â¿CÃ³mo funciona NTP? (Proceso paso a paso)

La sincronizaciÃ³n ocurre mediante el **intercambio de mensajes** entre cliente y servidor:

1. **El cliente envÃ­a una solicitud NTP** indicando la hora de salida del mensaje (T1).
2. **El servidor recibe la solicitud** y guarda el tiempo exacto en que la recibiÃ³ (T2).
3. **El servidor envÃ­a la respuesta** al cliente con dos datos:

   - La hora en que recibiÃ³ el mensaje (T2).
   - La hora en que enviÃ³ la respuesta (T3).

4. **El cliente recibe la respuesta** y anota la hora de llegada (T4).
5. Con esos valores (T1, T2, T3, T4), el cliente calcula:

   - **Retardo (delay):** cuÃ¡nto tardÃ³ el mensaje en ir y volver.
   - **Desfase (offset):** cuÃ¡nto debe ajustar su reloj.

ğŸ“Œ **Ejemplo prÃ¡ctico:**

- T1 = 10:00:01.000 (cliente envÃ­a peticiÃ³n).
- T2 = 10:00:01.050 (servidor recibe).
- T3 = 10:00:01.070 (servidor envÃ­a respuesta).
- T4 = 10:00:01.120 (cliente recibe).

ğŸ‘‰ Con estos datos, el cliente corrige su reloj para acercarse a la hora oficial.

### ğŸ§© Componentes del mensaje NTP

Un mensaje NTP contiene campos como:

- **Originate Timestamp (T1):** Tiempo cuando el cliente enviÃ³ la solicitud.
- **Receive Timestamp (T2):** Tiempo cuando el servidor la recibiÃ³.
- **Transmit Timestamp (T3):** Tiempo cuando el servidor enviÃ³ la respuesta.
- **Destination Timestamp (T4):** Tiempo cuando el cliente recibiÃ³ la respuesta.

### âš™ï¸ Modos de operaciÃ³n

NTP puede funcionar de distintas formas:

- **Cliente-Servidor:** (lo mÃ¡s comÃºn) â†’ Tu PC consulta un servidor NTP.
- **Peer-to-Peer:** Dos servidores se sincronizan entre sÃ­.
- **Broadcast/Multicast:** Un servidor envÃ­a la hora a muchos clientes a la vez.
- **Symmetric:** Usado en sincronizaciÃ³n entre servidores de alta precisiÃ³n.

ğŸ“Œ **Ejemplo:**

En una empresa, un servidor principal recibe la hora de Internet y la transmite por **broadcast** a todos los PCs de la oficina.

### ğŸ” Seguridad en NTP

NTP puede ser atacado de varias formas:

- **SuplantaciÃ³n de tiempo:** Un atacante envÃ­a una hora falsa.
- **Ataques DDoS de amplificaciÃ³n:** Usando servidores NTP mal configurados.

ğŸ‘‰ Para protegerse se usa:

- **AutenticaciÃ³n con claves criptogrÃ¡ficas.**
- **Versiones mÃ¡s seguras como NTPsec o Chrony.**

### ğŸ–¥ï¸ ImplementaciÃ³n y uso

- En **Windows**, tu PC suele sincronizar con `time.windows.com`.

- En **Linux**, puedes usar:

  ```bash
  sudo apt install ntp
  ntpq -p
  ```

  Esto muestra los servidores NTP configurados.

- Servidores pÃºblicos:

  - `pool.ntp.org` (red mundial de servidores NTP).
  - `time.google.com`.
  - `time.windows.com`.

ğŸ“Œ **Ejemplo real:**

Si una empresa bancaria no usa NTP y su servidor registra una transferencia con la hora equivocada, puede causar **errores legales y financieros**. Con NTP, todos los sistemas mantienen la misma hora exacta.

### âœ… Resumen final

- **NTP (Network Time Protocol)** sincroniza los relojes de los dispositivos en red.
- Usa un modelo jerÃ¡rquico de **estratos (stratum)**.
- Calcula **desfase y retardo** para ajustar la hora con precisiÃ³n.
- Es crÃ­tico en **redes, seguridad, finanzas, telecomunicaciones y sistemas distribuidos**.
- La mayorÃ­a de sistemas ya tienen NTP configurado por defecto.

---

[ğŸ”¼](#Ã­ndice)

---

| **Inicio**         | **atrÃ¡s 20**         | **Siguiente 22**     |
| ------------------ | -------------------- | -------------------- |
| [ğŸ ](../README.md) | [âª](./4_20_WLAN.md) | [â©](./4_22_IPAM.md) |
