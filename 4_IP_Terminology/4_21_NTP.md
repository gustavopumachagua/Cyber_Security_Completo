| **Inicio**         | **atrás 20**         | **Siguiente 22**     |
| ------------------ | -------------------- | -------------------- |
| [🏠](../README.md) | [⏪](./4_20_WLAN.md) | [⏩](./4_22_IPAM.md) |

---

## **Índice**

| Temario                                                                      |
| ---------------------------------------------------------------------------- |
| [120. ¿Qué es NTP?](#120-qué-es-ntp)                                         |
| [121. Protocolo de tiempo de red (NTP)](#121-protocolo-de-tiempo-de-red-ntp) |

# **NTP**

## **120. ¿Qué es NTP?**

![NTP](/img/4_IP_Terminology/NTP.png "NTP")

El **Network Time Protocol (NTP)** es un protocolo de red que permite sincronizar el reloj de los dispositivos (servidores, routers, PCs, smartphones) con gran precisión, generalmente con relojes de referencia como el **UTC (Tiempo Universal Coordinado)**.

👉 Fue creado en los años 80 por David L. Mills y es uno de los protocolos más antiguos aún en uso en Internet.

📌 **Ejemplo sencillo:**

Cuando tu laptop marca las **11:59:50**, pero el servidor oficial UTC marca las **12:00:00**, NTP ajusta tu reloj automáticamente para que coincidan.

### 🔑 Puntos clave sobre NTP

- Mantiene relojes sincronizados en **milisegundos** (en Internet) o incluso **microsegundos** (en redes locales).
- Funciona con el **puerto UDP 123**.
- Es un **protocolo jerárquico**, basado en niveles llamados **stratum** (estratos).

📌 **Ejemplo de jerarquía de estratos (stratum):**

1. **Stratum 0:** Relojes atómicos, GPS.
2. **Stratum 1:** Servidores directamente conectados a Stratum 0.
3. **Stratum 2:** Servidores sincronizados con Stratum 1.
4. **Stratum 3 en adelante:** Clientes o servidores que dependen de niveles superiores.

### 🔄 Proceso básico de comunicación NTP

La sincronización ocurre mediante un **intercambio de mensajes** entre cliente y servidor:

1. El cliente envía una solicitud NTP con la **hora en que salió el mensaje**.
2. El servidor responde con:

   - La hora en que recibió la solicitud.
   - La hora en que envió la respuesta.

3. El cliente compara su reloj con el servidor y calcula:

   - **Desfase (offset):** Diferencia entre su hora y la del servidor.
   - **Retardo (delay):** Tiempo que tardó el mensaje en ir y volver.

📌 **Ejemplo práctico:**

- Tu PC envía una petición a `time.google.com`.
- El servidor dice: "Recibí tu mensaje a las 10:00:01.123 y te respondo a las 10:00:01.223".
- Tu PC corrige su hora considerando el tiempo de viaje.

### 🧩 Componentes clave de los mensajes NTP

Un mensaje NTP contiene varios campos importantes:

- **Transmit Timestamp:** Hora en que el cliente envió el mensaje.
- **Receive Timestamp:** Hora en que el servidor lo recibió.
- **Transmit Timestamp del servidor:** Hora en que el servidor envió la respuesta.
- **Originate Timestamp:** Copia de la hora original del cliente.

### 🧮 Cálculo del desfase y retardo

El cliente puede calcular:

- **Retardo (Round-Trip Delay):**

  $$
  delay = (T4 - T1) - (T3 - T2)
  $$

- **Desfase (Clock Offset):**

  $$
  offset = \frac{(T2 - T1) + (T3 - T4)}{2}
  $$

📌 Donde:

- T1 = Tiempo en que cliente envió petición.
- T2 = Tiempo en que servidor recibió petición.
- T3 = Tiempo en que servidor envió respuesta.
- T4 = Tiempo en que cliente recibió respuesta.

👉 Esto asegura que se corrijan **retrasos de red**.

### ⚙️ Modos de operación

NTP puede trabajar en varios modos:

1. **Cliente-Servidor:** Un dispositivo consulta a un servidor NTP.
2. **Peer-to-Peer:** Dos dispositivos se sincronizan entre sí.
3. **Broadcast/Multicast:** Un servidor anuncia la hora y múltiples clientes la reciben.
4. **Symmetric:** Usado entre servidores para mayor precisión.

📌 **Ejemplo:**

- Tu PC (cliente) consulta a `time.windows.com` (servidor).
- Varios routers en una empresa usan modo **broadcast** para que todos los PCs se sincronicen a la vez.

### 🔐 Seguridad en NTP

NTP es vulnerable a:

- **Ataques de amplificación DDoS** (usando NTP mal configurado).
- **Suplantación de tiempo** (si un atacante envía respuestas falsas).

👉 Para protegerse, se usan:

- **NTP con autenticación** (claves criptográficas).
- **NTPsec** y **Chrony** (implementaciones más seguras y modernas).

### 🖥️ Implementación y uso

- Sistemas operativos modernos (Windows, Linux, macOS) ya incluyen soporte NTP.
- Servidores NTP públicos:

  - `time.google.com`
  - `time.windows.com`
  - `pool.ntp.org`

📌 **Ejemplo en Linux:**

```bash
sudo apt install ntp
ntpq -p
```

Esto muestra con qué servidores NTP está sincronizado tu equipo.

### 📛 Otros nombres para NTP

- **SNTP (Simple NTP):** Versión más ligera y sencilla, usada en dispositivos pequeños (IoT, routers).
- **NTPv4:** Versión más usada actualmente, compatible con IPv6.

### ✅ Resumen final

- **NTP** sincroniza relojes en red con precisión milimétrica.
- Usa **mensajes UDP en el puerto 123**.
- Calcula el **desfase y retardo** para ajustar la hora.
- Tiene varios **modos de operación** (cliente-servidor, broadcast, etc.).
- Es vital para **seguridad, logs, transacciones financieras, redes y comunicaciones**.

---

[🔼](#índice)

---

## **121. Protocolo de tiempo de red (NTP)**

### 🕒 ¿Qué es el Protocolo de Tiempo de Red (NTP)?

El **NTP (Network Time Protocol)** es un protocolo que se usa en las redes para **sincronizar los relojes de los dispositivos** (computadoras, routers, servidores, móviles, etc.) con gran precisión.

👉 Se ejecuta sobre **UDP, puerto 123**, y puede mantener relojes sincronizados con una diferencia de **milisegundos en Internet** y hasta **microsegundos en redes locales**.

📌 **Ejemplo sencillo:**

- Si tu laptop marca las **08:59:57**, pero la hora oficial (UTC) es **09:00:00**, NTP corrige automáticamente tu reloj para que coincida.

### 🔑 Características clave de NTP

- Funciona en una **jerarquía de estratos (stratum)**:

  - **Stratum 0:** Relojes de referencia (GPS, relojes atómicos).
  - **Stratum 1:** Servidores conectados directamente a Stratum 0.
  - **Stratum 2:** Servidores sincronizados con Stratum 1.
  - Y así sucesivamente.

- Usa un sistema de cálculo que tiene en cuenta el **retardo de red** para evitar errores de tiempo.

📌 **Ejemplo jerárquico:**

- Un servidor Stratum 1 se conecta a un reloj GPS.
- Tu proveedor de Internet usa servidores Stratum 2.
- Tu PC se sincroniza con esos servidores.

### 🔄 ¿Cómo funciona NTP? (Proceso paso a paso)

La sincronización ocurre mediante el **intercambio de mensajes** entre cliente y servidor:

1. **El cliente envía una solicitud NTP** indicando la hora de salida del mensaje (T1).
2. **El servidor recibe la solicitud** y guarda el tiempo exacto en que la recibió (T2).
3. **El servidor envía la respuesta** al cliente con dos datos:

   - La hora en que recibió el mensaje (T2).
   - La hora en que envió la respuesta (T3).

4. **El cliente recibe la respuesta** y anota la hora de llegada (T4).
5. Con esos valores (T1, T2, T3, T4), el cliente calcula:

   - **Retardo (delay):** cuánto tardó el mensaje en ir y volver.
   - **Desfase (offset):** cuánto debe ajustar su reloj.

📌 **Ejemplo práctico:**

- T1 = 10:00:01.000 (cliente envía petición).
- T2 = 10:00:01.050 (servidor recibe).
- T3 = 10:00:01.070 (servidor envía respuesta).
- T4 = 10:00:01.120 (cliente recibe).

👉 Con estos datos, el cliente corrige su reloj para acercarse a la hora oficial.

### 🧩 Componentes del mensaje NTP

Un mensaje NTP contiene campos como:

- **Originate Timestamp (T1):** Tiempo cuando el cliente envió la solicitud.
- **Receive Timestamp (T2):** Tiempo cuando el servidor la recibió.
- **Transmit Timestamp (T3):** Tiempo cuando el servidor envió la respuesta.
- **Destination Timestamp (T4):** Tiempo cuando el cliente recibió la respuesta.

### ⚙️ Modos de operación

NTP puede funcionar de distintas formas:

- **Cliente-Servidor:** (lo más común) → Tu PC consulta un servidor NTP.
- **Peer-to-Peer:** Dos servidores se sincronizan entre sí.
- **Broadcast/Multicast:** Un servidor envía la hora a muchos clientes a la vez.
- **Symmetric:** Usado en sincronización entre servidores de alta precisión.

📌 **Ejemplo:**

En una empresa, un servidor principal recibe la hora de Internet y la transmite por **broadcast** a todos los PCs de la oficina.

### 🔐 Seguridad en NTP

NTP puede ser atacado de varias formas:

- **Suplantación de tiempo:** Un atacante envía una hora falsa.
- **Ataques DDoS de amplificación:** Usando servidores NTP mal configurados.

👉 Para protegerse se usa:

- **Autenticación con claves criptográficas.**
- **Versiones más seguras como NTPsec o Chrony.**

### 🖥️ Implementación y uso

- En **Windows**, tu PC suele sincronizar con `time.windows.com`.

- En **Linux**, puedes usar:

  ```bash
  sudo apt install ntp
  ntpq -p
  ```

  Esto muestra los servidores NTP configurados.

- Servidores públicos:

  - `pool.ntp.org` (red mundial de servidores NTP).
  - `time.google.com`.
  - `time.windows.com`.

📌 **Ejemplo real:**

Si una empresa bancaria no usa NTP y su servidor registra una transferencia con la hora equivocada, puede causar **errores legales y financieros**. Con NTP, todos los sistemas mantienen la misma hora exacta.

### ✅ Resumen final

- **NTP (Network Time Protocol)** sincroniza los relojes de los dispositivos en red.
- Usa un modelo jerárquico de **estratos (stratum)**.
- Calcula **desfase y retardo** para ajustar la hora con precisión.
- Es crítico en **redes, seguridad, finanzas, telecomunicaciones y sistemas distribuidos**.
- La mayoría de sistemas ya tienen NTP configurado por defecto.

---

[🔼](#índice)

---

| **Inicio**         | **atrás 20**         | **Siguiente 22**     |
| ------------------ | -------------------- | -------------------- |
| [🏠](../README.md) | [⏪](./4_20_WLAN.md) | [⏩](./4_22_IPAM.md) |
