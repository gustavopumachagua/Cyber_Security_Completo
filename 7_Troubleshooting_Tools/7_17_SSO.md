| **Inicio**         | **atrás 16**         | **Siguiente 18**             |
| ------------------ | -------------------- | ---------------------------- |
| [🏠](../README.md) | [⏪](./7_16_LDAP.md) | [⏩](./7_18_Certificates.md) |

---

## **Índice**

| Temario                                                                                                                    |
| -------------------------------------------------------------------------------------------------------------------------- |
| [192. ¿Qué es el SSO? Cómo funciona el inicio de sesión único](#192-qué-es-el-sso-cómo-funciona-el-inicio-de-sesión-único) |
| [193. ¿Qué es el inicio de sesión único (SSO)? Cómo funciona](#193-qué-es-el-inicio-de-sesión-único-sso-cómo-funciona)     |

# **SSO**

## **192. ¿Qué es el SSO? Cómo funciona el inicio de sesión único**

![SSO](/img/7_Troubleshooting_Tools/SSO.webp "SSO")

### 🔹 1. ¿Qué es el inicio de sesión único (SSO)?

El **Single Sign-On (SSO)** es un mecanismo de autenticación que permite a un usuario acceder a **múltiples aplicaciones y servicios con una sola sesión de inicio de sesión**.

👉 En lugar de recordar y escribir contraseñas distintas para cada sistema, el usuario se autentica **una sola vez** en un proveedor de identidad (IdP), y este emite credenciales seguras (tokens) que otras aplicaciones confían.

📌 Ejemplo:

Inicias sesión en tu correo corporativo → automáticamente también tienes acceso a Teams, SharePoint, Jira y GitHub de la empresa, sin volver a poner usuario y contraseña.

### 🔹 2. Ventajas de SSO

- ✅ **Mejor experiencia de usuario** → menos contraseñas que recordar.
- ✅ **Seguridad reforzada** → reducción de contraseñas débiles/reutilizadas.
- ✅ **Gestión centralizada** → el equipo de IT controla accesos desde un único punto.
- ✅ **Cumplimiento normativo** → fácil revocación de acceso al desactivar al usuario.
- ✅ **Menos tickets de soporte** → menos reseteos de contraseña.

### 🔹 3. ¿Cómo funciona un inicio de sesión SSO?

El flujo típico incluye tres actores:

1. **Usuario** → abre una aplicación (ejemplo: Salesforce).
2. **Proveedor de servicio (SP)** → la app detecta que necesita autenticación.
3. **Proveedor de identidad (IdP)** → sistema central que valida credenciales (Okta, Azure AD, Google Identity).

👉 Flujo:

1. El usuario intenta acceder a una aplicación (SP).
2. La aplicación redirige al IdP (ejemplo: Okta).
3. El IdP autentica al usuario (credenciales + MFA).
4. El IdP devuelve un **token** firmado al SP.
5. El SP confía en ese token y concede acceso.

### 🔹 4. ¿Cómo funcionan los tokens de autenticación en SSO?

El IdP emite **tokens** digitales que contienen datos del usuario y están **firmados criptográficamente**.

- **SAML Assertions** → XML con atributos del usuario (ej. correo, roles).
- **JWT (JSON Web Token, usado en OpenID Connect)** → JSON con claims, firmado con clave privada.
- **Kerberos tickets** → credenciales cifradas que el cliente presenta en la red.

📌 Ejemplo con JWT:

```json
{
  "sub": "user123",
  "name": "Juan Pérez",
  "roles": ["admin", "ventas"],
  "exp": 1736167200
}
```

El servidor confía en el token porque está firmado por el IdP.

### 🔹 5. ¿Cómo encaja el SSO en la gestión de accesos?

- SSO es parte de la **IAM (Identity and Access Management)**.
- Se combina con:

  - **MFA (autenticación multifactor)** → aumenta la seguridad.
  - **Políticas de acceso condicional** (ej. “solo desde IP corporativa”).
  - **Zero Trust** → cada petición se valida con tokens cortos y renovables.

- Facilita auditoría y **desaprovisionamiento** rápido (dar de baja un usuario = adiós a todas las apps).

### 🔹 6. ¿Se integra Cloudflare con las soluciones de SSO?

Sí ✅.

- **Cloudflare Access** actúa como **puerta de entrada** (Zero Trust) y se integra con IdPs como Okta, Azure AD, Google, Ping Identity.
- Cloudflare no almacena las credenciales → solo valida los tokens emitidos por el IdP.
- Así, protege aplicaciones internas y SaaS detrás de Cloudflare.

### 🔹 7. ¿Cómo ayuda SSO con la gestión de contraseñas vs gestores tradicionales?

- Un **gestor de contraseñas** (ej. LastPass, Bitwarden) almacena credenciales individuales para cada sitio → el usuario sigue teniendo múltiples contraseñas.
- Con **SSO**:

  - No se usan contraseñas distintas → se confía en el token del IdP.
  - Si el usuario deja la empresa, basta con desactivar la cuenta en el IdP.

- Resultado: menos contraseñas escritas = menos vectores de ataque (phishing, reutilización).

### 🔹 8. Ventajas de seguridad de la identidad federada con SSO

- 🔐 **Autenticación centralizada y fuerte** (con MFA).
- 🔐 **Menos superficie de ataque** → una sola credencial en vez de decenas.
- 🔐 **Revocación inmediata** → al dar de baja el usuario en el IdP.
- 🔐 **Menos riesgo de phishing** → el usuario solo introduce credenciales en el portal corporativo, no en cada aplicación.
- 🔐 **Tokens con expiración** → reducen impacto si se roban.

### 🔹 9. ¿Cómo admite SSO la autenticación multifactor (MFA)?

El **MFA** se implementa en el **IdP**.

- Cuando el usuario inicia sesión, el IdP puede requerir:

  - OTP (Google Authenticator, Authy).
  - Push en una app móvil.
  - FIDO2/WebAuthn (llaves de seguridad como YubiKey).

- Una vez autenticado con MFA, **todas las aplicaciones integradas con SSO reciben el beneficio automáticamente** → no hay que configurar MFA en cada app.

### 🔹 10. Protocolos usados en SSO: Kerberos y SAML

- **Kerberos** (muy usado en redes corporativas/Windows):

  - El usuario obtiene un **TGT (Ticket Granting Ticket)** del KDC (Key Distribution Center).
  - Luego obtiene tickets de servicio para cada aplicación → no vuelve a introducir credenciales.
  - Ejemplo: inicio de sesión en Windows + acceso automático a recursos de red.

- **SAML (Security Assertion Markup Language)**:

  - Basado en XML.
  - IdP emite una **SAML Assertion** con datos del usuario.
  - Muy usado en aplicaciones web corporativas (ej. Salesforce, Workday).

Otros protocolos:

- **OAuth 2.0** (delegación de acceso).
- **OpenID Connect (OIDC)** (autenticación basada en OAuth 2.0 con JWT).

### ✅ Resumen final

- El **SSO** permite **una sola autenticación** para acceder a múltiples apps.
- Aporta **comodidad, seguridad y control centralizado**.
- Usa **tokens (SAML, JWT, Kerberos)** en lugar de múltiples contraseñas.
- Mejora la seguridad cuando se combina con **MFA** y **Zero Trust**.
- Protocolos clave: **Kerberos en entornos corporativos**, **SAML y OIDC en aplicaciones web modernas**.

---

[🔼](#índice)

---

## **193. ¿Qué es el inicio de sesión único (SSO)? Cómo funciona**

**Resumen corto:**

SSO (Single Sign-On) permite que un usuario se autentique **una sola vez** ante un proveedor de identidad (IdP) y, con esa prueba de identidad (un _token_ o _assertion_), acceda a muchas aplicaciones (Service Providers — SP) sin volver a introducir credenciales en cada una.

### 1 — Concepto básico y actores

- **Usuario**: la persona que quiere acceder a una app.
- **Service Provider (SP)**: la aplicación que requiere autenticación (ej. app.corporativa.com).
- **Identity Provider (IdP)**: sistema que autentica al usuario y emite tokens (Okta, Azure AD, Google, Auth0, un Kerberos KDC en entornos Windows).
- **Protocolo**: mecanismo que usan SP e IdP para intercambiar mensajes (SAML, OpenID Connect/OAuth2, Kerberos, WS-Federation).

### 2 — Idea general del flujo (conceptual)

1. Usuario solicita acceso a una app (SP).
2. SP redirige al **IdP** para autenticar (si no tiene sesión).
3. Usuario se autentica en IdP (usuario+contraseña, MFA, certificado).
4. IdP emite **token/asserction** firmado y lo devuelve al SP.
5. SP valida firma y claims del token y concede sesión al usuario.

Este intercambio evita que la app pida la contraseña: confía en la identidad emitida por el IdP.

### 3 — Dos ejemplos concretos de flujos

#### A) **SAML — SP-iniciado (web SSO)** (muy común en apps corporativas)

1. Usuario abre `https://app.example.com`.
2. SP detecta que no hay sesión → crea un `SAMLRequest` y redirige al IdP:
   `https://idp.example.com/sso?SAMLRequest=...&RelayState=...`
3. IdP autentica al usuario (login + opcional MFA).
4. IdP genera una **SAML Assertion** (XML) que contiene la identidad y atributos y la firma con su certificado.
5. IdP devuelve la Assertion al SP (HTTP POST) a la ACS (Assertion Consumer Service): `POST https://app.example.com/saml/acs` con `SAMLResponse=...`.
6. SP valida la firma, verifica `Audience` y `NotOnOrAfter`, crea su propia sesión y redirige al usuario a la página solicitada.

**Fragmento mínimo de SAML Assertion (ejemplo)**:

```xml
<saml:Assertion ...>
  <saml:Subject>
    <saml:NameID>juan@ejemplo.com</saml:NameID>
  </saml:Subject>
  <saml:AttributeStatement>
    <saml:Attribute Name="email"><saml:AttributeValue>juan@ejemplo.com</saml:AttributeValue></saml:Attribute>
  </saml:AttributeStatement>
</saml:Assertion>
```

#### B) **OpenID Connect (OIDC) — Authorization Code Flow (recomendado para apps modernas)**

1. Usuario va a `https://app.example.com`. SP (client) redirige al IdP `/authorize` con `client_id`, `redirect_uri`, `scope=openid`, `state` y (en móviles públicos) `code_challenge` (PKCE).
2. IdP autentica al usuario (y MFA si aplica).
3. IdP redirige de vuelta al SP con un **authorization code**:
   `https://app.example.com/callback?code=abc123&state=xyz`.
4. SP (servidor) hace una petición **server→IdP** al endpoint `/token` con `code` (+ `client_secret` o PKCE verifier) y recibe:

   - **id_token** (JWT) — autenticación;
   - **access_token** — acceso a APIs;
   - opcionalmente **refresh_token**.

5. SP valida la firma del `id_token`, el `iss`, `aud`, `exp` y crea sesión local.

**Ejemplo de payload decodificado de `id_token` (JWT):**

```json
{
  "iss": "https://idp.ejemplo.com",
  "sub": "auth0|123456",
  "aud": "client-id-app",
  "exp": 1712345678,
  "iat": 1712342078,
  "email": "juan@ejemplo.com"
}
```

#### C) **Kerberos (Windows / Intranet)**

- El usuario obtiene un **TGT** del KDC al iniciar sesión en Windows.
- Cuando accede a un servicio (SMB, HTTP internal) el cliente solicita un **service ticket** y presenta ese ticket al servicio —no hay redirecciones web.
- Esto se llama Integrated Windows Authentication y es SSO en entornos AD.

### 4 — SP-iniciado vs IdP-iniciado

- **SP-iniciado**: el usuario va primero a la app; ésta inicia la redirección al IdP (más control por la app).
- **IdP-iniciado**: el usuario entra al portal del IdP (dashboard) y hace click en la app; IdP crea la assertion y envía al SP.
  Ambos flujos funcionan; SP-iniciado es preferido para control de sesiones y estados (`state` parameter).

### 5 — ¿Qué llevan los tokens y cómo se validan?

Tokens contienen _claims_ / atributos:

- `iss` (issuer), `sub` (subject), `aud` (audience), `exp` (expiry), `iat`, `nonce` (OIDC), `email`, `roles`.
  Validación básica del SP:

1. Verificar **firma** del token/assertion con la clave pública del IdP (certificado/ JWKS).
2. Verificar `iss` y `aud`.
3. Verificar tiempos (`exp`, `nbf`).
4. Para OIDC: verificar `nonce` y `state` (prevent CSRF/replay).
5. Para SAML: validar `NotBefore`/`NotOnOrAfter`, y el `AudienceRestriction`.

### 6 — Sesiones, cookies y tokens: cómo se mantiene la sesión

- **IdP** mantiene una sesión (cookie segura) para no pedir usuario/contraseña cada vez que el SP redirige a autenticar.
- **SP** crea su propia sesión (por ejemplo cookie de sesión `Secure; HttpOnly; SameSite=Strict`) a partir del token.
- **Refresh tokens** permiten renovar `access_token` sin reautenticación (deben guardarse con mucho cuidado, idealmente en servidor).
- **Single Logout (SLO)** intenta cerrar sesión en IdP y en todos los SP; en la práctica SLO puede ser complejo y no siempre fiable (back-channel vs front-channel logout).

### 7 — Ventajas y desventajas (rápido)

**Ventajas**

- Mejor UX: menos logins.
- Menos contraseñas = menos reutilización / phishing.
- Administración centralizada: MFA, políticas, revocación al instante.

**Desventajas / riesgos**

- **Punto central crítico**: si IdP falla o es comprometido, muchas apps quedan expuestas.
- SLO poco fiable en algunos implementos.
- Configuración y trust (metadatos, certificados, redirect URIs) puede ser compleja.

### 8 — MFA, políticas y seguridad adicional

- **MFA** se aplica en el IdP (OTP, push, FIDO2). Todas las apps conectadas se benefician.
- **Condicional access**: el IdP puede requerir MFA solo si el acceso viene de una IP desconocida, geolocalización, riesgo de sesión, etc.
- **Mejoras de seguridad**:

  - usar TLS siempre (HTTPS),
  - tokens cortos (`exp` pequeño),
  - rotación de claves/JWKS,
  - revocación y detección de anomalías,
  - PKCE para clientes públicos,
  - sameSite + secure cookies.

### 9 — Consideraciones prácticas de implementación

- **Federación**: SP y IdP intercambian metadatos (endpoints, certificados, entityID).
- **Redirect URIs** deben estar **registradas** en el IdP (evitar open redirect).
- **Audience/Scope**: SP pide scopes (openid profile email) y IdP emite claims.
- **Provisioning**: IdP puede crear cuentas en SP _on-the-fly_ (Just-In-Time provisioning) o se usan procesos de provisioning (SCIM).
- **Auditoría**: logs centralizados en IdP para cumplimiento.

### 10 — Ejemplo práctico: paso a paso (OIDC Authorization Code + PKCE)

1. App (browser) → `GET /login` → redirect:
   `https://idp.ejemplo.com/authorize?response_type=code&client_id=XYZ&redirect_uri=https://app.ejemplo.com/cb&scope=openid%20email&state=abc&code_challenge=...`
2. Usuario en IdP se autentica y resuelve MFA.
3. IdP → redirect a `https://app.ejemplo.com/cb?code=AUTHCODE&state=abc`.
4. App backend POST `/token` (with code + code_verifier) → IdP returns `id_token` (JWT) + `access_token`.
5. App valida `id_token` (signature, iss, aud, exp), crea sesión y responde al usuario.

### 11 — Resumen rápido / Checklist de seguridad para desplegar SSO

- Forzar HTTPS en IdP y SP.
- Usar **Authorization Code Flow** + **PKCE** para clientes públicos.
- Validar firmas (JWKs/JWKS) y claims (iss, aud, exp, nonce).
- Aplicar **MFA** en IdP.
- Rotar claves y certificados periódicamente.
- Registrar y limitar `redirect_uri`.
- Monitorizar intentos fallidos y actividades anómalas.
- Plan de alta disponibilidad y disaster recovery para IdP.

---

[🔼](#índice)

---

| **Inicio**         | **atrás 16**         | **Siguiente 18**             |
| ------------------ | -------------------- | ---------------------------- |
| [🏠](../README.md) | [⏪](./7_16_LDAP.md) | [⏩](./7_18_Certificates.md) |
