| **Inicio**         | **atr√°s 16**         | **Siguiente 18**             |
| ------------------ | -------------------- | ---------------------------- |
| [üè†](../README.md) | [‚è™](./7_16_LDAP.md) | [‚è©](./7_18_Certificates.md) |

---

## **√çndice**

| Temario                                                                                                                    |
| -------------------------------------------------------------------------------------------------------------------------- |
| [192. ¬øQu√© es el SSO? C√≥mo funciona el inicio de sesi√≥n √∫nico](#192-qu√©-es-el-sso-c√≥mo-funciona-el-inicio-de-sesi√≥n-√∫nico) |
| [193. ¬øQu√© es el inicio de sesi√≥n √∫nico (SSO)? C√≥mo funciona](#193-qu√©-es-el-inicio-de-sesi√≥n-√∫nico-sso-c√≥mo-funciona)     |

# **SSO**

## **192. ¬øQu√© es el SSO? C√≥mo funciona el inicio de sesi√≥n √∫nico**

![SSO](/img/7_Troubleshooting_Tools/SSO.webp "SSO")

### üîπ 1. ¬øQu√© es el inicio de sesi√≥n √∫nico (SSO)?

El **Single Sign-On (SSO)** es un mecanismo de autenticaci√≥n que permite a un usuario acceder a **m√∫ltiples aplicaciones y servicios con una sola sesi√≥n de inicio de sesi√≥n**.

üëâ En lugar de recordar y escribir contrase√±as distintas para cada sistema, el usuario se autentica **una sola vez** en un proveedor de identidad (IdP), y este emite credenciales seguras (tokens) que otras aplicaciones conf√≠an.

üìå Ejemplo:

Inicias sesi√≥n en tu correo corporativo ‚Üí autom√°ticamente tambi√©n tienes acceso a Teams, SharePoint, Jira y GitHub de la empresa, sin volver a poner usuario y contrase√±a.

### üîπ 2. Ventajas de SSO

- ‚úÖ **Mejor experiencia de usuario** ‚Üí menos contrase√±as que recordar.
- ‚úÖ **Seguridad reforzada** ‚Üí reducci√≥n de contrase√±as d√©biles/reutilizadas.
- ‚úÖ **Gesti√≥n centralizada** ‚Üí el equipo de IT controla accesos desde un √∫nico punto.
- ‚úÖ **Cumplimiento normativo** ‚Üí f√°cil revocaci√≥n de acceso al desactivar al usuario.
- ‚úÖ **Menos tickets de soporte** ‚Üí menos reseteos de contrase√±a.

### üîπ 3. ¬øC√≥mo funciona un inicio de sesi√≥n SSO?

El flujo t√≠pico incluye tres actores:

1. **Usuario** ‚Üí abre una aplicaci√≥n (ejemplo: Salesforce).
2. **Proveedor de servicio (SP)** ‚Üí la app detecta que necesita autenticaci√≥n.
3. **Proveedor de identidad (IdP)** ‚Üí sistema central que valida credenciales (Okta, Azure AD, Google Identity).

üëâ Flujo:

1. El usuario intenta acceder a una aplicaci√≥n (SP).
2. La aplicaci√≥n redirige al IdP (ejemplo: Okta).
3. El IdP autentica al usuario (credenciales + MFA).
4. El IdP devuelve un **token** firmado al SP.
5. El SP conf√≠a en ese token y concede acceso.

### üîπ 4. ¬øC√≥mo funcionan los tokens de autenticaci√≥n en SSO?

El IdP emite **tokens** digitales que contienen datos del usuario y est√°n **firmados criptogr√°ficamente**.

- **SAML Assertions** ‚Üí XML con atributos del usuario (ej. correo, roles).
- **JWT (JSON Web Token, usado en OpenID Connect)** ‚Üí JSON con claims, firmado con clave privada.
- **Kerberos tickets** ‚Üí credenciales cifradas que el cliente presenta en la red.

üìå Ejemplo con JWT:

```json
{
  "sub": "user123",
  "name": "Juan P√©rez",
  "roles": ["admin", "ventas"],
  "exp": 1736167200
}
```

El servidor conf√≠a en el token porque est√° firmado por el IdP.

### üîπ 5. ¬øC√≥mo encaja el SSO en la gesti√≥n de accesos?

- SSO es parte de la **IAM (Identity and Access Management)**.
- Se combina con:

  - **MFA (autenticaci√≥n multifactor)** ‚Üí aumenta la seguridad.
  - **Pol√≠ticas de acceso condicional** (ej. ‚Äúsolo desde IP corporativa‚Äù).
  - **Zero Trust** ‚Üí cada petici√≥n se valida con tokens cortos y renovables.

- Facilita auditor√≠a y **desaprovisionamiento** r√°pido (dar de baja un usuario = adi√≥s a todas las apps).

### üîπ 6. ¬øSe integra Cloudflare con las soluciones de SSO?

S√≠ ‚úÖ.

- **Cloudflare Access** act√∫a como **puerta de entrada** (Zero Trust) y se integra con IdPs como Okta, Azure AD, Google, Ping Identity.
- Cloudflare no almacena las credenciales ‚Üí solo valida los tokens emitidos por el IdP.
- As√≠, protege aplicaciones internas y SaaS detr√°s de Cloudflare.

### üîπ 7. ¬øC√≥mo ayuda SSO con la gesti√≥n de contrase√±as vs gestores tradicionales?

- Un **gestor de contrase√±as** (ej. LastPass, Bitwarden) almacena credenciales individuales para cada sitio ‚Üí el usuario sigue teniendo m√∫ltiples contrase√±as.
- Con **SSO**:

  - No se usan contrase√±as distintas ‚Üí se conf√≠a en el token del IdP.
  - Si el usuario deja la empresa, basta con desactivar la cuenta en el IdP.

- Resultado: menos contrase√±as escritas = menos vectores de ataque (phishing, reutilizaci√≥n).

### üîπ 8. Ventajas de seguridad de la identidad federada con SSO

- üîê **Autenticaci√≥n centralizada y fuerte** (con MFA).
- üîê **Menos superficie de ataque** ‚Üí una sola credencial en vez de decenas.
- üîê **Revocaci√≥n inmediata** ‚Üí al dar de baja el usuario en el IdP.
- üîê **Menos riesgo de phishing** ‚Üí el usuario solo introduce credenciales en el portal corporativo, no en cada aplicaci√≥n.
- üîê **Tokens con expiraci√≥n** ‚Üí reducen impacto si se roban.

### üîπ 9. ¬øC√≥mo admite SSO la autenticaci√≥n multifactor (MFA)?

El **MFA** se implementa en el **IdP**.

- Cuando el usuario inicia sesi√≥n, el IdP puede requerir:

  - OTP (Google Authenticator, Authy).
  - Push en una app m√≥vil.
  - FIDO2/WebAuthn (llaves de seguridad como YubiKey).

- Una vez autenticado con MFA, **todas las aplicaciones integradas con SSO reciben el beneficio autom√°ticamente** ‚Üí no hay que configurar MFA en cada app.

### üîπ 10. Protocolos usados en SSO: Kerberos y SAML

- **Kerberos** (muy usado en redes corporativas/Windows):

  - El usuario obtiene un **TGT (Ticket Granting Ticket)** del KDC (Key Distribution Center).
  - Luego obtiene tickets de servicio para cada aplicaci√≥n ‚Üí no vuelve a introducir credenciales.
  - Ejemplo: inicio de sesi√≥n en Windows + acceso autom√°tico a recursos de red.

- **SAML (Security Assertion Markup Language)**:

  - Basado en XML.
  - IdP emite una **SAML Assertion** con datos del usuario.
  - Muy usado en aplicaciones web corporativas (ej. Salesforce, Workday).

Otros protocolos:

- **OAuth 2.0** (delegaci√≥n de acceso).
- **OpenID Connect (OIDC)** (autenticaci√≥n basada en OAuth 2.0 con JWT).

### ‚úÖ Resumen final

- El **SSO** permite **una sola autenticaci√≥n** para acceder a m√∫ltiples apps.
- Aporta **comodidad, seguridad y control centralizado**.
- Usa **tokens (SAML, JWT, Kerberos)** en lugar de m√∫ltiples contrase√±as.
- Mejora la seguridad cuando se combina con **MFA** y **Zero Trust**.
- Protocolos clave: **Kerberos en entornos corporativos**, **SAML y OIDC en aplicaciones web modernas**.

---

[üîº](#√≠ndice)

---

## **193. ¬øQu√© es el inicio de sesi√≥n √∫nico (SSO)? C√≥mo funciona**

**Resumen corto:**

SSO (Single Sign-On) permite que un usuario se autentique **una sola vez** ante un proveedor de identidad (IdP) y, con esa prueba de identidad (un _token_ o _assertion_), acceda a muchas aplicaciones (Service Providers ‚Äî SP) sin volver a introducir credenciales en cada una.

### 1 ‚Äî Concepto b√°sico y actores

- **Usuario**: la persona que quiere acceder a una app.
- **Service Provider (SP)**: la aplicaci√≥n que requiere autenticaci√≥n (ej. app.corporativa.com).
- **Identity Provider (IdP)**: sistema que autentica al usuario y emite tokens (Okta, Azure AD, Google, Auth0, un Kerberos KDC en entornos Windows).
- **Protocolo**: mecanismo que usan SP e IdP para intercambiar mensajes (SAML, OpenID Connect/OAuth2, Kerberos, WS-Federation).

### 2 ‚Äî Idea general del flujo (conceptual)

1. Usuario solicita acceso a una app (SP).
2. SP redirige al **IdP** para autenticar (si no tiene sesi√≥n).
3. Usuario se autentica en IdP (usuario+contrase√±a, MFA, certificado).
4. IdP emite **token/asserction** firmado y lo devuelve al SP.
5. SP valida firma y claims del token y concede sesi√≥n al usuario.

Este intercambio evita que la app pida la contrase√±a: conf√≠a en la identidad emitida por el IdP.

### 3 ‚Äî Dos ejemplos concretos de flujos

#### A) **SAML ‚Äî SP-iniciado (web SSO)** (muy com√∫n en apps corporativas)

1. Usuario abre `https://app.example.com`.
2. SP detecta que no hay sesi√≥n ‚Üí crea un `SAMLRequest` y redirige al IdP:
   `https://idp.example.com/sso?SAMLRequest=...&RelayState=...`
3. IdP autentica al usuario (login + opcional MFA).
4. IdP genera una **SAML Assertion** (XML) que contiene la identidad y atributos y la firma con su certificado.
5. IdP devuelve la Assertion al SP (HTTP POST) a la ACS (Assertion Consumer Service): `POST https://app.example.com/saml/acs` con `SAMLResponse=...`.
6. SP valida la firma, verifica `Audience` y `NotOnOrAfter`, crea su propia sesi√≥n y redirige al usuario a la p√°gina solicitada.

**Fragmento m√≠nimo de SAML Assertion (ejemplo)**:

```xml
<saml:Assertion ...>
  <saml:Subject>
    <saml:NameID>juan@ejemplo.com</saml:NameID>
  </saml:Subject>
  <saml:AttributeStatement>
    <saml:Attribute Name="email"><saml:AttributeValue>juan@ejemplo.com</saml:AttributeValue></saml:Attribute>
  </saml:AttributeStatement>
</saml:Assertion>
```

#### B) **OpenID Connect (OIDC) ‚Äî Authorization Code Flow (recomendado para apps modernas)**

1. Usuario va a `https://app.example.com`. SP (client) redirige al IdP `/authorize` con `client_id`, `redirect_uri`, `scope=openid`, `state` y (en m√≥viles p√∫blicos) `code_challenge` (PKCE).
2. IdP autentica al usuario (y MFA si aplica).
3. IdP redirige de vuelta al SP con un **authorization code**:
   `https://app.example.com/callback?code=abc123&state=xyz`.
4. SP (servidor) hace una petici√≥n **server‚ÜíIdP** al endpoint `/token` con `code` (+ `client_secret` o PKCE verifier) y recibe:

   - **id_token** (JWT) ‚Äî autenticaci√≥n;
   - **access_token** ‚Äî acceso a APIs;
   - opcionalmente **refresh_token**.

5. SP valida la firma del `id_token`, el `iss`, `aud`, `exp` y crea sesi√≥n local.

**Ejemplo de payload decodificado de `id_token` (JWT):**

```json
{
  "iss": "https://idp.ejemplo.com",
  "sub": "auth0|123456",
  "aud": "client-id-app",
  "exp": 1712345678,
  "iat": 1712342078,
  "email": "juan@ejemplo.com"
}
```

#### C) **Kerberos (Windows / Intranet)**

- El usuario obtiene un **TGT** del KDC al iniciar sesi√≥n en Windows.
- Cuando accede a un servicio (SMB, HTTP internal) el cliente solicita un **service ticket** y presenta ese ticket al servicio ‚Äîno hay redirecciones web.
- Esto se llama Integrated Windows Authentication y es SSO en entornos AD.

### 4 ‚Äî SP-iniciado vs IdP-iniciado

- **SP-iniciado**: el usuario va primero a la app; √©sta inicia la redirecci√≥n al IdP (m√°s control por la app).
- **IdP-iniciado**: el usuario entra al portal del IdP (dashboard) y hace click en la app; IdP crea la assertion y env√≠a al SP.
  Ambos flujos funcionan; SP-iniciado es preferido para control de sesiones y estados (`state` parameter).

### 5 ‚Äî ¬øQu√© llevan los tokens y c√≥mo se validan?

Tokens contienen _claims_ / atributos:

- `iss` (issuer), `sub` (subject), `aud` (audience), `exp` (expiry), `iat`, `nonce` (OIDC), `email`, `roles`.
  Validaci√≥n b√°sica del SP:

1. Verificar **firma** del token/assertion con la clave p√∫blica del IdP (certificado/ JWKS).
2. Verificar `iss` y `aud`.
3. Verificar tiempos (`exp`, `nbf`).
4. Para OIDC: verificar `nonce` y `state` (prevent CSRF/replay).
5. Para SAML: validar `NotBefore`/`NotOnOrAfter`, y el `AudienceRestriction`.

### 6 ‚Äî Sesiones, cookies y tokens: c√≥mo se mantiene la sesi√≥n

- **IdP** mantiene una sesi√≥n (cookie segura) para no pedir usuario/contrase√±a cada vez que el SP redirige a autenticar.
- **SP** crea su propia sesi√≥n (por ejemplo cookie de sesi√≥n `Secure; HttpOnly; SameSite=Strict`) a partir del token.
- **Refresh tokens** permiten renovar `access_token` sin reautenticaci√≥n (deben guardarse con mucho cuidado, idealmente en servidor).
- **Single Logout (SLO)** intenta cerrar sesi√≥n en IdP y en todos los SP; en la pr√°ctica SLO puede ser complejo y no siempre fiable (back-channel vs front-channel logout).

### 7 ‚Äî Ventajas y desventajas (r√°pido)

**Ventajas**

- Mejor UX: menos logins.
- Menos contrase√±as = menos reutilizaci√≥n / phishing.
- Administraci√≥n centralizada: MFA, pol√≠ticas, revocaci√≥n al instante.

**Desventajas / riesgos**

- **Punto central cr√≠tico**: si IdP falla o es comprometido, muchas apps quedan expuestas.
- SLO poco fiable en algunos implementos.
- Configuraci√≥n y trust (metadatos, certificados, redirect URIs) puede ser compleja.

### 8 ‚Äî MFA, pol√≠ticas y seguridad adicional

- **MFA** se aplica en el IdP (OTP, push, FIDO2). Todas las apps conectadas se benefician.
- **Condicional access**: el IdP puede requerir MFA solo si el acceso viene de una IP desconocida, geolocalizaci√≥n, riesgo de sesi√≥n, etc.
- **Mejoras de seguridad**:

  - usar TLS siempre (HTTPS),
  - tokens cortos (`exp` peque√±o),
  - rotaci√≥n de claves/JWKS,
  - revocaci√≥n y detecci√≥n de anomal√≠as,
  - PKCE para clientes p√∫blicos,
  - sameSite + secure cookies.

### 9 ‚Äî Consideraciones pr√°cticas de implementaci√≥n

- **Federaci√≥n**: SP y IdP intercambian metadatos (endpoints, certificados, entityID).
- **Redirect URIs** deben estar **registradas** en el IdP (evitar open redirect).
- **Audience/Scope**: SP pide scopes (openid profile email) y IdP emite claims.
- **Provisioning**: IdP puede crear cuentas en SP _on-the-fly_ (Just-In-Time provisioning) o se usan procesos de provisioning (SCIM).
- **Auditor√≠a**: logs centralizados en IdP para cumplimiento.

### 10 ‚Äî Ejemplo pr√°ctico: paso a paso (OIDC Authorization Code + PKCE)

1. App (browser) ‚Üí `GET /login` ‚Üí redirect:
   `https://idp.ejemplo.com/authorize?response_type=code&client_id=XYZ&redirect_uri=https://app.ejemplo.com/cb&scope=openid%20email&state=abc&code_challenge=...`
2. Usuario en IdP se autentica y resuelve MFA.
3. IdP ‚Üí redirect a `https://app.ejemplo.com/cb?code=AUTHCODE&state=abc`.
4. App backend POST `/token` (with code + code_verifier) ‚Üí IdP returns `id_token` (JWT) + `access_token`.
5. App valida `id_token` (signature, iss, aud, exp), crea sesi√≥n y responde al usuario.

### 11 ‚Äî Resumen r√°pido / Checklist de seguridad para desplegar SSO

- Forzar HTTPS en IdP y SP.
- Usar **Authorization Code Flow** + **PKCE** para clientes p√∫blicos.
- Validar firmas (JWKs/JWKS) y claims (iss, aud, exp, nonce).
- Aplicar **MFA** en IdP.
- Rotar claves y certificados peri√≥dicamente.
- Registrar y limitar `redirect_uri`.
- Monitorizar intentos fallidos y actividades an√≥malas.
- Plan de alta disponibilidad y disaster recovery para IdP.

---

[üîº](#√≠ndice)

---

| **Inicio**         | **atr√°s 16**         | **Siguiente 18**             |
| ------------------ | -------------------- | ---------------------------- |
| [üè†](../README.md) | [‚è™](./7_16_LDAP.md) | [‚è©](./7_18_Certificates.md) |
